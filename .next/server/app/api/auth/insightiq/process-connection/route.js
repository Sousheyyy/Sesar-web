"use strict";(()=>{var e={};e.id=5801,e.ids=[5801],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},65723:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>I,patchFetch:()=>_,requestAsyncStorage:()=>p,routeModule:()=>g,serverHooks:()=>m,staticGenerationAsyncStorage:()=>f});var o={};r.r(o),r.d(o,{POST:()=>h});var n=r(49303),s=r(88716),i=r(60670),a=r(87070),c=r(57815),l=r(72331),u=r(91800);let d=null;async function h(e){try{let t=await (0,c.I)();if(!t?.user?.id)return a.NextResponse.json({error:"Unauthorized"},{status:401});let{userId:r,accounts:o}=await e.json();if(console.log("[InsightIQ] Processing connection results:",{ourUserId:t.user.id,phylloUserId:r,accounts:o}),!o||0===o.length)return a.NextResponse.json({error:"No accounts connected"},{status:400});d||(d=await u.x.getTikTokPlatformId());let n=o.find(e=>e.work_platform_id===d||e.work_platform_id?.toLowerCase().includes("tiktok"));if(!n)return a.NextResponse.json({error:"No TikTok account found"},{status:400});console.log("[InsightIQ] TikTok account connected:",n.account_id);let s=null;try{s=await u.x.getAccount(n.account_id),console.log("[InsightIQ] Account details:",s)}catch(e){console.error("[InsightIQ] Failed to fetch account details:",e)}let i={tiktokUserId:n.account_id,tiktokConnectedAt:new Date};return s&&(s.username&&(i.tiktokUsername=s.username,i.tiktokHandle=s.username),s.platform_profile_name&&(i.tiktokDisplayName=s.platform_profile_name),s.platform_profile_picture_url&&(i.tiktokAvatarUrl=s.platform_profile_picture_url)),await l.prisma.user.update({where:{id:t.user.id},data:i}),console.log("[InsightIQ] User updated with TikTok connection"),a.NextResponse.json({success:!0,message:"TikTok connection processed",accountId:n.account_id})}catch(e){return console.error("[InsightIQ] Process connection error:",e),a.NextResponse.json({error:"Failed to process connection",message:e instanceof Error?e.message:"Unknown error"},{status:500})}}let g=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/auth/insightiq/process-connection/route",pathname:"/api/auth/insightiq/process-connection",filename:"route",bundlePath:"app/api/auth/insightiq/process-connection/route"},resolvedPagePath:"C:\\Users\\ilker\\Desktop\\sesar-web\\app\\api\\auth\\insightiq\\process-connection\\route.ts",nextConfigOutput:"standalone",userland:o}),{requestAsyncStorage:p,staticGenerationAsyncStorage:f,serverHooks:m}=g,I="/api/auth/insightiq/process-connection/route";function _(){return(0,i.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:f})}},57815:(e,t,r)=>{r.d(t,{I:()=>a});var o=r(72331),n=r(20344),s=r(71615);let i=()=>(0,n.createServerComponentClient)({cookies:s.cookies});async function a(){let e=i();try{let{data:{user:t},error:r}=await e.auth.getUser();if(r||!t)return null;let n=await o.prisma.user.findUnique({where:{id:t.id}});if(!n)return null;return{user:{id:n.id,email:n.email,name:n.name,role:n.role,plan:n.plan,balance:Number(n.balance),tiktokHandle:n.tiktokHandle},expires:null}}catch(e){return console.error("Auth helper error:",e),null}}},91800:(e,t,r)=>{r.d(t,{x:()=>n});class o{constructor(e){if(this.config=e,this.isConfigured=!!(e.clientId&&e.clientSecret&&e.baseUrl),e.clientId&&e.clientSecret){let t=`${e.clientId}:${e.clientSecret}`;this.basicAuthHeader=`Basic ${Buffer.from(t).toString("base64")}`}else this.basicAuthHeader=""}checkConfiguration(){if(!this.isConfigured)throw Error("InsightIQ is not configured. Please set INSIGHTIQ_CLIENT_ID, INSIGHTIQ_CLIENT_SECRET, and INSIGHTIQ_BASE_URL environment variables.")}isInsightIQConfigured(){return this.isConfigured}sleep(e){return new Promise(t=>setTimeout(t,e))}async request(e,t={},r=!1,o,n=0){this.checkConfiguration();let s=`${this.config.baseUrl}${e}`,i=t.method||"GET",a=t.body,c={"Content-Type":"application/json",Authorization:this.basicAuthHeader};r&&o?(c["X-User-Token"]=o,console.log("[InsightIQ] Auth: Basic + User Token")):console.log("[InsightIQ] Auth: Basic Auth"),console.log("[InsightIQ] Request URL:",s),console.log("[InsightIQ] Method:",i);try{let l=await fetch(s,{method:i,headers:c,body:a||void 0});if(!l.ok){let s=await l.text(),i=s,a=`HTTP_${l.status}`;try{let e=JSON.parse(s);i=e.error?.message||e.message||e.error||s,a=e.error?.code||e.code||a}catch(e){}if(console.error("[InsightIQ] API Error:",l.status,i),429===l.status){let s=l.headers.get("Retry-After"),i=s?1e3*parseInt(s,10):1e3*Math.pow(2,n);if(n<3)return console.log(`[InsightIQ] Rate limited. Retrying in ${i}ms (attempt ${n+1}/3)`),await this.sleep(i),this.request(e,t,r,o,n+1)}if(n<3&&l.status>=500){let s=1e3*Math.pow(2,n);return console.log(`[InsightIQ] Server error. Retrying in ${s}ms (attempt ${n+1}/3)`),await this.sleep(s),this.request(e,t,r,o,n+1)}throw Error(`InsightIQ API Error (${l.status}): ${i}`)}return l.json()}catch(s){if(n<3&&s instanceof TypeError){let s=1e3*Math.pow(2,n);return console.log(`[InsightIQ] Network error, retrying in ${s}ms (attempt ${n+1}/3)`),await this.sleep(s),this.request(e,t,r,o,n+1)}throw s}}async createUser(e,t){return this.request("/v1/users",{method:"POST",body:JSON.stringify({external_id:e,name:t||e})})}async getOrCreateUser(e,t){try{let t=await this.request(`/v1/users/external_id/${e}`,{method:"GET"});return console.log("[InsightIQ] Found existing user:",t.id),t}catch(r){if(r.message?.includes("404")||r.message?.includes("not found")){console.log("[InsightIQ] User not found, creating new user...");let r=await this.createUser(e,t);return console.log("[InsightIQ] Created new user:",r.id),r}throw r}}async createSdkToken(e,t=["IDENTITY","ENGAGEMENT"],r){let o={user_id:e,products:t};r&&(o.redirect_url=r);let n=await this.request("/v1/sdk-tokens",{method:"POST",body:JSON.stringify(o)});return console.log("[InsightIQ] SDK Token Response:",JSON.stringify(n,null,2)),{sdk_token:n.sdk_token||n.token,sdk_token_id:n.sdk_token_id||n.id,expires_at:n.expires_at,user_id:n.user_id,connect_url:n.connect_url||n.url}}getConnectUrl(e,t,r){let o;o="sandbox"===r||this.config.baseUrl.includes("sandbox")?"https://connect.sandbox.insightiq.ai":"staging"===r||this.config.baseUrl.includes("staging")?"https://connect.staging.insightiq.ai":"https://connect.insightiq.ai";let n=new URLSearchParams;n.set("sdk_token",e),t&&n.set("work_platform_id",t);let s=`${o}?${n.toString()}`;return console.log("[InsightIQ] Connect URL:",s),s}async getAccount(e){let t=await this.request(`/v1/accounts/${e}`,{method:"GET"});return console.log("[InsightIQ] Account details:",JSON.stringify(t,null,2)),{id:t.id,user_id:t.user_id,work_platform_id:t.work_platform_id,username:t.username||t.platform_username,platform_username:t.platform_username,platform_profile_name:t.platform_profile_name,platform_profile_picture_url:t.platform_profile_picture_url,status:t.status,created_at:t.created_at,updated_at:t.updated_at}}async getWorkPlatforms(){let e=await this.request("/v1/work-platforms",{method:"GET"});return console.log("[InsightIQ] Work platforms:",JSON.stringify(e,null,2)),e}async getTikTokPlatformId(){try{let e=await this.getWorkPlatforms(),t=e.data?.find(e=>e.name.toLowerCase().includes("tiktok"));if(t)return console.log("[InsightIQ] Found TikTok platform:",t),t.id;return null}catch(e){return console.error("[InsightIQ] Failed to get TikTok platform ID:",e),null}}async initiateConnection(e){throw Error("initiateConnection is deprecated. Use createSdkToken() to get an SDK token, then initialize the Connect SDK on the frontend.")}async exchangeToken(e){return this.request("/v1/connect/token",{method:"POST",body:JSON.stringify({user_token:e})})}async refreshToken(e){return this.request("/v1/connect/refresh",{method:"POST",body:JSON.stringify({refresh_token:e})})}async getUserContents(e,t){let r=new URLSearchParams({platform:"tiktok",limit:String(t?.limit||50),offset:String(t?.offset||0)});return t?.from_date&&r.set("from_date",t.from_date),t?.to_date&&r.set("to_date",t.to_date),this.request(`/v1/social/contents?${r}`,{},!0,e)}async fetchContentByUrl(e,t){let r;let o=t||await this.getTikTokPlatformId();if(!o)throw Error("Could not determine TikTok work platform ID");let n=await this.request("/v1/social/creators/contents/fetch",{method:"POST",body:JSON.stringify({content_url:e,work_platform_id:o})});if(console.log("[InsightIQ] Raw response type:",Array.isArray(n)?"array":typeof n),Array.isArray(n)?(r=n[0],console.log("[InsightIQ] Extracted first item from array")):n.data?(r=n.data,console.log("[InsightIQ] Extracted data property")):(r=n,console.log("[InsightIQ] Using response directly")),!r)throw Error("No content returned from API");return console.log("[InsightIQ] Processed content has audio_track_info:",!!r.audio_track_info),r}async getContentByAccountId(e,t){let r=new URLSearchParams({account_id:e,limit:String(t?.limit||50),offset:String(t?.offset||0)});return t?.from_date&&r.set("from_date",t.from_date),t?.to_date&&r.set("to_date",t.to_date),this.request(`/v1/social/contents?${r}`,{method:"GET"})}async getProfileByAccountId(e){return this.request(`/v1/profiles?account_id=${e}`,{method:"GET"})}async findVideosByMusicIdForAccount(e,t,r=100){return(await this.getContentByAccountId(e,{limit:r})).data.filter(e=>e.audio_track_info?.id===t)}async getUserIdentity(e){return this.request("/v1/social/identity?platform=tiktok",{},!0,e)}async findVideosByMusicId(e,t,r=100){return(await this.getUserContents(e,{limit:r})).data.filter(e=>e.audio_track_info?.id===t)}async getAllUserContents(e){let t=[],r=0,o=!0;for(;o;){let n=await this.getUserContents(e,{limit:100,offset:r});if(t.push(...n.data),o=n.pagination.has_more,(r+=100)>1e3){console.warn("Reached safety limit of 1000 videos");break}}return t}}let n=new o({clientId:process.env.INSIGHTIQ_CLIENT_ID||"",clientSecret:process.env.INSIGHTIQ_CLIENT_SECRET||"",baseUrl:process.env.INSIGHTIQ_BASE_URL||"",redirectUri:process.env.INSIGHTIQ_REDIRECT_URI||""})},72331:(e,t,r)=>{r.d(t,{prisma:()=>n});var o=r(53524);let n=globalThis.prisma??new o.PrismaClient({log:["error"]})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[8948,958,5972],()=>r(65723));module.exports=o})();