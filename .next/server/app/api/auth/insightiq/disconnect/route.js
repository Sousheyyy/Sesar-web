"use strict";(()=>{var e={};e.id=7929,e.ids=[7929],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},640:(e,t,i)=>{i.r(t),i.d(t,{originalPathname:()=>g,patchFetch:()=>m,requestAsyncStorage:()=>d,routeModule:()=>k,serverHooks:()=>h,staticGenerationAsyncStorage:()=>p});var n={};i.r(n),i.d(n,{POST:()=>l});var r=i(49303),s=i(88716),o=i(60670),a=i(87070),c=i(57815),u=i(44430);async function l(e){try{let e=await (0,c.I)();if(!e?.user?.id)return a.NextResponse.json({error:"Unauthorized"},{status:401});return console.log(`[InsightIQ] Disconnecting TikTok for user: ${e.user.id}`),await (0,u.Uc)(e.user.id),console.log("[InsightIQ] TikTok disconnected successfully"),a.NextResponse.json({success:!0,message:"TikTok account disconnected"})}catch(e){return console.error("[InsightIQ] Error disconnecting TikTok:",e),a.NextResponse.json({error:"Failed to disconnect TikTok",message:e instanceof Error?e.message:"Unknown error"},{status:500})}}let k=new r.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/auth/insightiq/disconnect/route",pathname:"/api/auth/insightiq/disconnect",filename:"route",bundlePath:"app/api/auth/insightiq/disconnect/route"},resolvedPagePath:"C:\\Users\\ilker\\Desktop\\sesar-web\\app\\api\\auth\\insightiq\\disconnect\\route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:d,staticGenerationAsyncStorage:p,serverHooks:h}=k,g="/api/auth/insightiq/disconnect/route";function m(){return(0,o.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:p})}},57815:(e,t,i)=>{i.d(t,{I:()=>a});var n=i(72331),r=i(20344),s=i(71615);let o=()=>(0,r.createServerComponentClient)({cookies:s.cookies});async function a(){let e=o();try{let{data:{user:t},error:i}=await e.auth.getUser();if(i||!t)return null;let r=await n.prisma.user.findUnique({where:{id:t.id}});if(!r)return null;return{user:{id:r.id,email:r.email,name:r.name,role:r.role,plan:r.plan,balance:Number(r.balance),tiktokHandle:r.tiktokHandle},expires:null}}catch(e){return console.error("Auth helper error:",e),null}}},44430:(e,t,i)=>{i.d(t,{RN:()=>o,Uc:()=>a,pD:()=>c});var n=i(72331),r=i(91800),s=i(67297);async function o(e){let t=await n.prisma.user.findUnique({where:{id:e},select:{insightiqAccessToken:!0,insightiqRefreshToken:!0,insightiqTokenExpiry:!0}});if(!t?.insightiqAccessToken||!t?.insightiqRefreshToken)throw Error("User has not connected their TikTok account via InsightIQ. Please complete OAuth flow first.");let i=new Date,o=t.insightiqTokenExpiry;if(!o||o.getTime()-i.getTime()<3e5){console.log(`Refreshing access token for user ${e}`);let i=(0,s.sw)(t.insightiqRefreshToken),o=await r.x.refreshToken(i),a=new Date;return a.setSeconds(a.getSeconds()+o.expires_in),await n.prisma.user.update({where:{id:e},data:{insightiqAccessToken:(0,s.n0)(o.access_token),insightiqRefreshToken:(0,s.n0)(o.refresh_token),insightiqTokenExpiry:a}}),o.access_token}return(0,s.sw)(t.insightiqAccessToken)}async function a(e){await n.prisma.user.update({where:{id:e},data:{insightiqAccessToken:null,insightiqRefreshToken:null,insightiqTokenExpiry:null,tiktokUserId:null,tiktokUsername:null,tiktokDisplayName:null,tiktokAvatarUrl:null,tiktokConnectedAt:null}})}async function c(e){let t=await n.prisma.user.findUnique({where:{id:e},select:{tiktokUserId:!0,tiktokUsername:!0,tiktokDisplayName:!0,tiktokAvatarUrl:!0,tiktokConnectedAt:!0,insightiqTokenExpiry:!0}});if(!t?.tiktokUserId)return{connected:!1,user:null};let i=new Date,r=t.insightiqTokenExpiry?Math.floor((t.insightiqTokenExpiry.getTime()-i.getTime())/1e3):0;return{connected:!0,user:{userId:t.tiktokUserId,username:t.tiktokUsername,displayName:t.tiktokDisplayName,avatarUrl:t.tiktokAvatarUrl,connectedAt:t.tiktokConnectedAt,tokenExpiresIn:r}}}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),n=t.X(0,[8948,958,5972,5861],()=>i(640));module.exports=n})();