"use strict";(()=>{var e={};e.id=5764,e.ids=[5764],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17624:(e,t,i)=>{i.r(t),i.d(t,{originalPathname:()=>g,patchFetch:()=>m,requestAsyncStorage:()=>k,routeModule:()=>p,serverHooks:()=>h,staticGenerationAsyncStorage:()=>d});var n={};i.r(n),i.d(n,{GET:()=>l});var r=i(49303),s=i(88716),a=i(60670),o=i(87070),u=i(57815),c=i(44430);async function l(e){try{let e=await (0,u.I)();if(!e?.user?.id)return o.NextResponse.json({error:"Unauthorized"},{status:401});let t=await (0,c.pD)(e.user.id);return o.NextResponse.json({success:!0,...t})}catch(e){return console.error("[InsightIQ] Error getting connection status:",e),o.NextResponse.json({error:"Failed to get connection status",message:e instanceof Error?e.message:"Unknown error"},{status:500})}}let p=new r.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/auth/insightiq/status/route",pathname:"/api/auth/insightiq/status",filename:"route",bundlePath:"app/api/auth/insightiq/status/route"},resolvedPagePath:"C:\\Users\\ilker\\Desktop\\sesar-web\\app\\api\\auth\\insightiq\\status\\route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:k,staticGenerationAsyncStorage:d,serverHooks:h}=p,g="/api/auth/insightiq/status/route";function m(){return(0,a.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:d})}},57815:(e,t,i)=>{i.d(t,{I:()=>o});var n=i(72331),r=i(20344),s=i(71615);let a=()=>(0,r.createServerComponentClient)({cookies:s.cookies});async function o(){let e=a();try{let{data:{user:t},error:i}=await e.auth.getUser();if(i||!t)return null;let r=await n.prisma.user.findUnique({where:{id:t.id}});if(!r)return null;return{user:{id:r.id,email:r.email,name:r.name,role:r.role,plan:r.plan,balance:Number(r.balance),tiktokHandle:r.tiktokHandle},expires:null}}catch(e){return console.error("Auth helper error:",e),null}}},44430:(e,t,i)=>{i.d(t,{RN:()=>a,Uc:()=>o,pD:()=>u});var n=i(72331),r=i(91800),s=i(67297);async function a(e){let t=await n.prisma.user.findUnique({where:{id:e},select:{insightiqAccessToken:!0,insightiqRefreshToken:!0,insightiqTokenExpiry:!0}});if(!t?.insightiqAccessToken||!t?.insightiqRefreshToken)throw Error("User has not connected their TikTok account via InsightIQ. Please complete OAuth flow first.");let i=new Date,a=t.insightiqTokenExpiry;if(!a||a.getTime()-i.getTime()<3e5){console.log(`Refreshing access token for user ${e}`);let i=(0,s.sw)(t.insightiqRefreshToken),a=await r.x.refreshToken(i),o=new Date;return o.setSeconds(o.getSeconds()+a.expires_in),await n.prisma.user.update({where:{id:e},data:{insightiqAccessToken:(0,s.n0)(a.access_token),insightiqRefreshToken:(0,s.n0)(a.refresh_token),insightiqTokenExpiry:o}}),a.access_token}return(0,s.sw)(t.insightiqAccessToken)}async function o(e){await n.prisma.user.update({where:{id:e},data:{insightiqAccessToken:null,insightiqRefreshToken:null,insightiqTokenExpiry:null,tiktokUserId:null,tiktokUsername:null,tiktokDisplayName:null,tiktokAvatarUrl:null,tiktokConnectedAt:null}})}async function u(e){let t=await n.prisma.user.findUnique({where:{id:e},select:{tiktokUserId:!0,tiktokUsername:!0,tiktokDisplayName:!0,tiktokAvatarUrl:!0,tiktokConnectedAt:!0,insightiqTokenExpiry:!0}});if(!t?.tiktokUserId)return{connected:!1,user:null};let i=new Date,r=t.insightiqTokenExpiry?Math.floor((t.insightiqTokenExpiry.getTime()-i.getTime())/1e3):0;return{connected:!0,user:{userId:t.tiktokUserId,username:t.tiktokUsername,displayName:t.tiktokDisplayName,avatarUrl:t.tiktokAvatarUrl,connectedAt:t.tiktokConnectedAt,tokenExpiresIn:r}}}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),n=t.X(0,[8948,958,5972,5861],()=>i(17624));module.exports=n})();