"use strict";(()=>{var e={};e.id=8558,e.ids=[8558],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},49128:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>p,patchFetch:()=>m,requestAsyncStorage:()=>h,routeModule:()=>g,serverHooks:()=>f,staticGenerationAsyncStorage:()=>I});var n={};r.r(n),r.d(n,{POST:()=>d});var s=r(49303),o=r(88716),i=r(60670),a=r(87070),l=r(57815),c=r(91800);let u=null;async function d(e){try{let e=await (0,l.I)();if(!e?.user?.id)return a.NextResponse.json({error:"Unauthorized - Please login first"},{status:401});let t=e.user.id,r=e.user.name||e.user.email||t;console.log(`[InsightIQ] Initiating connection for user: ${t}`),console.log("[InsightIQ] Step 1: Getting/creating InsightIQ user...");let n=await c.x.getOrCreateUser(t,r);console.log("[InsightIQ] Step 2: Creating SDK token...");let s=await c.x.createSdkToken(n.id,["IDENTITY","ENGAGEMENT"]);console.log("[InsightIQ] SDK token created successfully"),console.log("[InsightIQ] SDK Token ID:",s.sdk_token_id);let o=process.env.INSIGHTIQ_BASE_URL?.includes("sandbox")?"sandbox":process.env.INSIGHTIQ_BASE_URL?.includes("staging")?"staging":"production";return u||(console.log("[InsightIQ] Step 3: Fetching TikTok platform ID..."),u=await c.x.getTikTokPlatformId(),console.log("[InsightIQ] TikTok platform ID:",u)),a.NextResponse.json({success:!0,token:s.sdk_token,userId:n.id,environment:o,workPlatformId:u,sdkTokenId:s.sdk_token_id,expiresAt:s.expires_at})}catch(e){return console.error("[InsightIQ] Error:",e),a.NextResponse.json({error:"Failed to initiate TikTok connection",message:e instanceof Error?e.message:"Unknown error"},{status:500})}}let g=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/auth/insightiq/initiate/route",pathname:"/api/auth/insightiq/initiate",filename:"route",bundlePath:"app/api/auth/insightiq/initiate/route"},resolvedPagePath:"C:\\Users\\ilker\\Desktop\\sesar-web\\app\\api\\auth\\insightiq\\initiate\\route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:h,staticGenerationAsyncStorage:I,serverHooks:f}=g,p="/api/auth/insightiq/initiate/route";function m(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:I})}},57815:(e,t,r)=>{r.d(t,{I:()=>a});var n=r(72331),s=r(20344),o=r(71615);let i=()=>(0,s.createServerComponentClient)({cookies:o.cookies});async function a(){let e=i();try{let{data:{user:t},error:r}=await e.auth.getUser();if(r||!t)return null;let s=await n.prisma.user.findUnique({where:{id:t.id}});if(!s)return null;return{user:{id:s.id,email:s.email,name:s.name,role:s.role,plan:s.plan,balance:Number(s.balance),tiktokHandle:s.tiktokHandle},expires:null}}catch(e){return console.error("Auth helper error:",e),null}}},91800:(e,t,r)=>{r.d(t,{x:()=>s});class n{constructor(e){if(this.config=e,this.isConfigured=!!(e.clientId&&e.clientSecret&&e.baseUrl),e.clientId&&e.clientSecret){let t=`${e.clientId}:${e.clientSecret}`;this.basicAuthHeader=`Basic ${Buffer.from(t).toString("base64")}`}else this.basicAuthHeader=""}checkConfiguration(){if(!this.isConfigured)throw Error("InsightIQ is not configured. Please set INSIGHTIQ_CLIENT_ID, INSIGHTIQ_CLIENT_SECRET, and INSIGHTIQ_BASE_URL environment variables.")}isInsightIQConfigured(){return this.isConfigured}sleep(e){return new Promise(t=>setTimeout(t,e))}async request(e,t={},r=!1,n,s=0){this.checkConfiguration();let o=`${this.config.baseUrl}${e}`,i=t.method||"GET",a=t.body,l={"Content-Type":"application/json",Authorization:this.basicAuthHeader};r&&n?(l["X-User-Token"]=n,console.log("[InsightIQ] Auth: Basic + User Token")):console.log("[InsightIQ] Auth: Basic Auth"),console.log("[InsightIQ] Request URL:",o),console.log("[InsightIQ] Method:",i);try{let c=await fetch(o,{method:i,headers:l,body:a||void 0});if(!c.ok){let o=await c.text(),i=o,a=`HTTP_${c.status}`;try{let e=JSON.parse(o);i=e.error?.message||e.message||e.error||o,a=e.error?.code||e.code||a}catch(e){}if(console.error("[InsightIQ] API Error:",c.status,i),429===c.status){let o=c.headers.get("Retry-After"),i=o?1e3*parseInt(o,10):1e3*Math.pow(2,s);if(s<3)return console.log(`[InsightIQ] Rate limited. Retrying in ${i}ms (attempt ${s+1}/3)`),await this.sleep(i),this.request(e,t,r,n,s+1)}if(s<3&&c.status>=500){let o=1e3*Math.pow(2,s);return console.log(`[InsightIQ] Server error. Retrying in ${o}ms (attempt ${s+1}/3)`),await this.sleep(o),this.request(e,t,r,n,s+1)}throw Error(`InsightIQ API Error (${c.status}): ${i}`)}return c.json()}catch(o){if(s<3&&o instanceof TypeError){let o=1e3*Math.pow(2,s);return console.log(`[InsightIQ] Network error, retrying in ${o}ms (attempt ${s+1}/3)`),await this.sleep(o),this.request(e,t,r,n,s+1)}throw o}}async createUser(e,t){return this.request("/v1/users",{method:"POST",body:JSON.stringify({external_id:e,name:t||e})})}async getOrCreateUser(e,t){try{let t=await this.request(`/v1/users/external_id/${e}`,{method:"GET"});return console.log("[InsightIQ] Found existing user:",t.id),t}catch(r){if(r.message?.includes("404")||r.message?.includes("not found")){console.log("[InsightIQ] User not found, creating new user...");let r=await this.createUser(e,t);return console.log("[InsightIQ] Created new user:",r.id),r}throw r}}async createSdkToken(e,t=["IDENTITY","ENGAGEMENT"],r){let n={user_id:e,products:t};r&&(n.redirect_url=r);let s=await this.request("/v1/sdk-tokens",{method:"POST",body:JSON.stringify(n)});return console.log("[InsightIQ] SDK Token Response:",JSON.stringify(s,null,2)),{sdk_token:s.sdk_token||s.token,sdk_token_id:s.sdk_token_id||s.id,expires_at:s.expires_at,user_id:s.user_id,connect_url:s.connect_url||s.url}}getConnectUrl(e,t,r){let n;n="sandbox"===r||this.config.baseUrl.includes("sandbox")?"https://connect.sandbox.insightiq.ai":"staging"===r||this.config.baseUrl.includes("staging")?"https://connect.staging.insightiq.ai":"https://connect.insightiq.ai";let s=new URLSearchParams;s.set("sdk_token",e),t&&s.set("work_platform_id",t);let o=`${n}?${s.toString()}`;return console.log("[InsightIQ] Connect URL:",o),o}async getAccount(e){let t=await this.request(`/v1/accounts/${e}`,{method:"GET"});return console.log("[InsightIQ] Account details:",JSON.stringify(t,null,2)),{id:t.id,user_id:t.user_id,work_platform_id:t.work_platform_id,username:t.username||t.platform_username,platform_username:t.platform_username,platform_profile_name:t.platform_profile_name,platform_profile_picture_url:t.platform_profile_picture_url,status:t.status,created_at:t.created_at,updated_at:t.updated_at}}async getWorkPlatforms(){let e=await this.request("/v1/work-platforms",{method:"GET"});return console.log("[InsightIQ] Work platforms:",JSON.stringify(e,null,2)),e}async getTikTokPlatformId(){try{let e=await this.getWorkPlatforms(),t=e.data?.find(e=>e.name.toLowerCase().includes("tiktok"));if(t)return console.log("[InsightIQ] Found TikTok platform:",t),t.id;return null}catch(e){return console.error("[InsightIQ] Failed to get TikTok platform ID:",e),null}}async initiateConnection(e){throw Error("initiateConnection is deprecated. Use createSdkToken() to get an SDK token, then initialize the Connect SDK on the frontend.")}async exchangeToken(e){return this.request("/v1/connect/token",{method:"POST",body:JSON.stringify({user_token:e})})}async refreshToken(e){return this.request("/v1/connect/refresh",{method:"POST",body:JSON.stringify({refresh_token:e})})}async getUserContents(e,t){let r=new URLSearchParams({platform:"tiktok",limit:String(t?.limit||50),offset:String(t?.offset||0)});return t?.from_date&&r.set("from_date",t.from_date),t?.to_date&&r.set("to_date",t.to_date),this.request(`/v1/social/contents?${r}`,{},!0,e)}async fetchContentByUrl(e,t){let r;let n=t||await this.getTikTokPlatformId();if(!n)throw Error("Could not determine TikTok work platform ID");let s=await this.request("/v1/social/creators/contents/fetch",{method:"POST",body:JSON.stringify({content_url:e,work_platform_id:n})});if(console.log("[InsightIQ] Raw response type:",Array.isArray(s)?"array":typeof s),Array.isArray(s)?(r=s[0],console.log("[InsightIQ] Extracted first item from array")):s.data?(r=s.data,console.log("[InsightIQ] Extracted data property")):(r=s,console.log("[InsightIQ] Using response directly")),!r)throw Error("No content returned from API");return console.log("[InsightIQ] Processed content has audio_track_info:",!!r.audio_track_info),r}async getContentByAccountId(e,t){let r=new URLSearchParams({account_id:e,limit:String(t?.limit||50),offset:String(t?.offset||0)});return t?.from_date&&r.set("from_date",t.from_date),t?.to_date&&r.set("to_date",t.to_date),this.request(`/v1/social/contents?${r}`,{method:"GET"})}async getProfileByAccountId(e){return this.request(`/v1/profiles?account_id=${e}`,{method:"GET"})}async findVideosByMusicIdForAccount(e,t,r=100){return(await this.getContentByAccountId(e,{limit:r})).data.filter(e=>e.audio_track_info?.id===t)}async getUserIdentity(e){return this.request("/v1/social/identity?platform=tiktok",{},!0,e)}async findVideosByMusicId(e,t,r=100){return(await this.getUserContents(e,{limit:r})).data.filter(e=>e.audio_track_info?.id===t)}async getAllUserContents(e){let t=[],r=0,n=!0;for(;n;){let s=await this.getUserContents(e,{limit:100,offset:r});if(t.push(...s.data),n=s.pagination.has_more,(r+=100)>1e3){console.warn("Reached safety limit of 1000 videos");break}}return t}}let s=new n({clientId:process.env.INSIGHTIQ_CLIENT_ID||"",clientSecret:process.env.INSIGHTIQ_CLIENT_SECRET||"",baseUrl:process.env.INSIGHTIQ_BASE_URL||"",redirectUri:process.env.INSIGHTIQ_REDIRECT_URI||""})},72331:(e,t,r)=>{r.d(t,{prisma:()=>s});var n=r(53524);let s=globalThis.prisma??new n.PrismaClient({log:["error"]})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[8948,958,5972],()=>r(49128));module.exports=n})();