"use strict";(()=>{var e={};e.id=4911,e.ids=[4911],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},39610:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>I,patchFetch:()=>y,requestAsyncStorage:()=>f,routeModule:()=>m,serverHooks:()=>k,staticGenerationAsyncStorage:()=>p});var o={};r.r(o),r.d(o,{POST:()=>h,dynamic:()=>g});var n=r(49303),s=r(88716),i=r(60670),a=r(87070),l=r(57815),c=r(72331),u=r(91800),d=r(83924);let g="force-dynamic";async function h(e){try{let t=await (0,l.I)();if(!t?.user?.id)return a.NextResponse.json({error:"Unauthorized"},{status:401});if(!u.x.isInsightIQConfigured())return a.NextResponse.json({error:"Service not configured",message:"InsightIQ API is not configured. Please contact support."},{status:503});let{tiktokUrl:r}=await e.json();if(!r)return a.NextResponse.json({error:"TikTok URL is required"},{status:400});let o=(0,d.s7)(r),n=(0,d.yW)(o),s=(0,d.Nn)(o);if(!n&&!s)return a.NextResponse.json({error:"Invalid TikTok URL",message:"Please provide a valid TikTok video URL (e.g., tiktok.com/@user/video/123)"},{status:400});if(s)return a.NextResponse.json({error:"Music URL not supported",message:"L\xfctfen şarkınızı kullanan bir TikTok video linki yapıştırın. Video linkinden şarkı bilgileri otomatik olarak \xe7ekilecektir. \xd6rn: tiktok.com/@user/video/123",hint:"video_url_required"},{status:400});let i=null,g=null,h=null,m=0;console.log("[Song Upload] Processing video URL via InsightIQ...");try{let e=await u.x.fetchContentByUrl(o);if(console.log("[Song Upload] Video content fetched:",JSON.stringify(e,null,2)),!e.audio_track_info)return a.NextResponse.json({error:"No music found",message:"Bu videoda tanımlanabilir bir m\xfczik par\xe7ası bulunamadı. L\xfctfen şarkı i\xe7eren başka bir video deneyin."},{status:400});i=(g=e.audio_track_info).id,h=g.cover_url||e.thumbnail_url,e.engagement?.plays,m=1,console.log("[Song Upload] Music extracted from video:",{title:g.title,artist:g.artist,musicId:i,thumbnailUrl:h})}catch(e){return console.error("[Song Upload] Error fetching video content:",e),a.NextResponse.json({error:"Could not fetch video",message:"Video bilgileri alınamadı. L\xfctfen URL'yi kontrol edip tekrar deneyin.",details:e.message},{status:400})}if(!i||!g)return a.NextResponse.json({error:"Could not extract music information",message:"Unable to get music metadata from the provided URL."},{status:400});let f=await c.prisma.song.findUnique({where:{tiktokMusicId:i}});if(f){if(f.artistId===t.user.id)return a.NextResponse.json({success:!0,song:f,videoCount:f.videoCount||0,message:"Song already exists in your library",existing:!0});return a.NextResponse.json({error:"Song already exists",message:"This song has already been added by another artist",song:{id:f.id,title:f.title,authorName:f.authorName}},{status:409})}console.log(`[Song Upload] Creating song: ${g.title} by ${g.artist}`);let p=await c.prisma.song.create({data:{title:g.title,authorName:g.artist,coverImage:g.cover_url||h||null,tiktokUrl:o,tiktokMusicId:i,musicCoverUrl:g.cover_url||null,musicUrl:g.url||o,duration:g.duration||null,videoCount:m||null,statsLastFetched:new Date,artist:{connect:{id:t.user.id}}}});return console.log(`[Song Upload] Song created successfully: ${p.id}`),a.NextResponse.json({success:!0,song:p,videoCount:m,message:`Song "${g.title}" by ${g.artist} added successfully`})}catch(e){if(console.error("[Song Upload] Error:",e),e instanceof Error){if(e.message.includes("not connected"))return a.NextResponse.json({error:"TikTok not connected",message:"Please connect your TikTok account first",requiresConnection:!0},{status:403});if(e.message.includes("InsightIQ API Error"))return a.NextResponse.json({error:"API Error",message:e.message},{status:502});if(e.message.includes("not configured"))return a.NextResponse.json({error:"Service not configured",message:"The TikTok integration service is not properly configured."},{status:503})}return a.NextResponse.json({error:"Failed to upload song",message:e instanceof Error?e.message:"Unknown error"},{status:500})}}let m=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/songs/upload/route",pathname:"/api/songs/upload",filename:"route",bundlePath:"app/api/songs/upload/route"},resolvedPagePath:"C:\\Users\\ilker\\Desktop\\sesar-web\\app\\api\\songs\\upload\\route.ts",nextConfigOutput:"standalone",userland:o}),{requestAsyncStorage:f,staticGenerationAsyncStorage:p,serverHooks:k}=m,I="/api/songs/upload/route";function y(){return(0,i.patchFetch)({serverHooks:k,staticGenerationAsyncStorage:p})}},57815:(e,t,r)=>{r.d(t,{I:()=>a});var o=r(72331),n=r(20344),s=r(71615);let i=()=>(0,n.createServerComponentClient)({cookies:s.cookies});async function a(){let e=i();try{let{data:{user:t},error:r}=await e.auth.getUser();if(r||!t)return null;let n=await o.prisma.user.findUnique({where:{id:t.id}});if(!n)return null;return{user:{id:n.id,email:n.email,name:n.name,role:n.role,plan:n.plan,balance:Number(n.balance),tiktokHandle:n.tiktokHandle},expires:null}}catch(e){return console.error("Auth helper error:",e),null}}},91800:(e,t,r)=>{r.d(t,{x:()=>n});class o{constructor(e){if(this.config=e,this.isConfigured=!!(e.clientId&&e.clientSecret&&e.baseUrl),e.clientId&&e.clientSecret){let t=`${e.clientId}:${e.clientSecret}`;this.basicAuthHeader=`Basic ${Buffer.from(t).toString("base64")}`}else this.basicAuthHeader=""}checkConfiguration(){if(!this.isConfigured)throw Error("InsightIQ is not configured. Please set INSIGHTIQ_CLIENT_ID, INSIGHTIQ_CLIENT_SECRET, and INSIGHTIQ_BASE_URL environment variables.")}isInsightIQConfigured(){return this.isConfigured}sleep(e){return new Promise(t=>setTimeout(t,e))}async request(e,t={},r=!1,o,n=0){this.checkConfiguration();let s=`${this.config.baseUrl}${e}`,i=t.method||"GET",a=t.body,l={"Content-Type":"application/json",Authorization:this.basicAuthHeader};r&&o?(l["X-User-Token"]=o,console.log("[InsightIQ] Auth: Basic + User Token")):console.log("[InsightIQ] Auth: Basic Auth"),console.log("[InsightIQ] Request URL:",s),console.log("[InsightIQ] Method:",i);try{let c=await fetch(s,{method:i,headers:l,body:a||void 0});if(!c.ok){let s=await c.text(),i=s,a=`HTTP_${c.status}`;try{let e=JSON.parse(s);i=e.error?.message||e.message||e.error||s,a=e.error?.code||e.code||a}catch(e){}if(console.error("[InsightIQ] API Error:",c.status,i),429===c.status){let s=c.headers.get("Retry-After"),i=s?1e3*parseInt(s,10):1e3*Math.pow(2,n);if(n<3)return console.log(`[InsightIQ] Rate limited. Retrying in ${i}ms (attempt ${n+1}/3)`),await this.sleep(i),this.request(e,t,r,o,n+1)}if(n<3&&c.status>=500){let s=1e3*Math.pow(2,n);return console.log(`[InsightIQ] Server error. Retrying in ${s}ms (attempt ${n+1}/3)`),await this.sleep(s),this.request(e,t,r,o,n+1)}throw Error(`InsightIQ API Error (${c.status}): ${i}`)}return c.json()}catch(s){if(n<3&&s instanceof TypeError){let s=1e3*Math.pow(2,n);return console.log(`[InsightIQ] Network error, retrying in ${s}ms (attempt ${n+1}/3)`),await this.sleep(s),this.request(e,t,r,o,n+1)}throw s}}async createUser(e,t){return this.request("/v1/users",{method:"POST",body:JSON.stringify({external_id:e,name:t||e})})}async getOrCreateUser(e,t){try{let t=await this.request(`/v1/users/external_id/${e}`,{method:"GET"});return console.log("[InsightIQ] Found existing user:",t.id),t}catch(r){if(r.message?.includes("404")||r.message?.includes("not found")){console.log("[InsightIQ] User not found, creating new user...");let r=await this.createUser(e,t);return console.log("[InsightIQ] Created new user:",r.id),r}throw r}}async createSdkToken(e,t=["IDENTITY","ENGAGEMENT"],r){let o={user_id:e,products:t};r&&(o.redirect_url=r);let n=await this.request("/v1/sdk-tokens",{method:"POST",body:JSON.stringify(o)});return console.log("[InsightIQ] SDK Token Response:",JSON.stringify(n,null,2)),{sdk_token:n.sdk_token||n.token,sdk_token_id:n.sdk_token_id||n.id,expires_at:n.expires_at,user_id:n.user_id,connect_url:n.connect_url||n.url}}getConnectUrl(e,t,r){let o;o="sandbox"===r||this.config.baseUrl.includes("sandbox")?"https://connect.sandbox.insightiq.ai":"staging"===r||this.config.baseUrl.includes("staging")?"https://connect.staging.insightiq.ai":"https://connect.insightiq.ai";let n=new URLSearchParams;n.set("sdk_token",e),t&&n.set("work_platform_id",t);let s=`${o}?${n.toString()}`;return console.log("[InsightIQ] Connect URL:",s),s}async getAccount(e){let t=await this.request(`/v1/accounts/${e}`,{method:"GET"});return console.log("[InsightIQ] Account details:",JSON.stringify(t,null,2)),{id:t.id,user_id:t.user_id,work_platform_id:t.work_platform_id,username:t.username||t.platform_username,platform_username:t.platform_username,platform_profile_name:t.platform_profile_name,platform_profile_picture_url:t.platform_profile_picture_url,status:t.status,created_at:t.created_at,updated_at:t.updated_at}}async getWorkPlatforms(){let e=await this.request("/v1/work-platforms",{method:"GET"});return console.log("[InsightIQ] Work platforms:",JSON.stringify(e,null,2)),e}async getTikTokPlatformId(){try{let e=await this.getWorkPlatforms(),t=e.data?.find(e=>e.name.toLowerCase().includes("tiktok"));if(t)return console.log("[InsightIQ] Found TikTok platform:",t),t.id;return null}catch(e){return console.error("[InsightIQ] Failed to get TikTok platform ID:",e),null}}async initiateConnection(e){throw Error("initiateConnection is deprecated. Use createSdkToken() to get an SDK token, then initialize the Connect SDK on the frontend.")}async exchangeToken(e){return this.request("/v1/connect/token",{method:"POST",body:JSON.stringify({user_token:e})})}async refreshToken(e){return this.request("/v1/connect/refresh",{method:"POST",body:JSON.stringify({refresh_token:e})})}async getUserContents(e,t){let r=new URLSearchParams({platform:"tiktok",limit:String(t?.limit||50),offset:String(t?.offset||0)});return t?.from_date&&r.set("from_date",t.from_date),t?.to_date&&r.set("to_date",t.to_date),this.request(`/v1/social/contents?${r}`,{},!0,e)}async fetchContentByUrl(e,t){let r;let o=t||await this.getTikTokPlatformId();if(!o)throw Error("Could not determine TikTok work platform ID");let n=await this.request("/v1/social/creators/contents/fetch",{method:"POST",body:JSON.stringify({content_url:e,work_platform_id:o})});if(console.log("[InsightIQ] Raw response type:",Array.isArray(n)?"array":typeof n),Array.isArray(n)?(r=n[0],console.log("[InsightIQ] Extracted first item from array")):n.data?(r=n.data,console.log("[InsightIQ] Extracted data property")):(r=n,console.log("[InsightIQ] Using response directly")),!r)throw Error("No content returned from API");return console.log("[InsightIQ] Processed content has audio_track_info:",!!r.audio_track_info),r}async getContentByAccountId(e,t){let r=new URLSearchParams({account_id:e,limit:String(t?.limit||50),offset:String(t?.offset||0)});return t?.from_date&&r.set("from_date",t.from_date),t?.to_date&&r.set("to_date",t.to_date),this.request(`/v1/social/contents?${r}`,{method:"GET"})}async getProfileByAccountId(e){return this.request(`/v1/profiles?account_id=${e}`,{method:"GET"})}async findVideosByMusicIdForAccount(e,t,r=100){return(await this.getContentByAccountId(e,{limit:r})).data.filter(e=>e.audio_track_info?.id===t)}async getUserIdentity(e){return this.request("/v1/social/identity?platform=tiktok",{},!0,e)}async findVideosByMusicId(e,t,r=100){return(await this.getUserContents(e,{limit:r})).data.filter(e=>e.audio_track_info?.id===t)}async getAllUserContents(e){let t=[],r=0,o=!0;for(;o;){let n=await this.getUserContents(e,{limit:100,offset:r});if(t.push(...n.data),o=n.pagination.has_more,(r+=100)>1e3){console.warn("Reached safety limit of 1000 videos");break}}return t}}let n=new o({clientId:process.env.INSIGHTIQ_CLIENT_ID||"",clientSecret:process.env.INSIGHTIQ_CLIENT_SECRET||"",baseUrl:process.env.INSIGHTIQ_BASE_URL||"",redirectUri:process.env.INSIGHTIQ_REDIRECT_URI||""})},83924:(e,t,r)=>{function o(e){try{let t=e.match(/\/video\/(\d+)/);return t?t[1]:null}catch(e){return console.error("Error extracting video ID:",e),null}}function n(e){return e.includes("tiktok.com/music/")}function s(e){return e.includes("tiktok.com/@")&&e.includes("/video/")}function i(e){return e.replace("vm.tiktok.com","www.tiktok.com").replace("m.tiktok.com","www.tiktok.com")}r.d(t,{Nn:()=>n,Tm:()=>o,s7:()=>i,yW:()=>s})},72331:(e,t,r)=>{r.d(t,{prisma:()=>n});var o=r(53524);let n=globalThis.prisma??new o.PrismaClient({log:["error"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[8948,958,5972],()=>r(39610));module.exports=o})();