"use strict";
/*
 * ATTENTION: An "eval-source-map" devtool has been used.
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file with attached SourceMaps in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
exports.id = "_rsc_server_services_submissionHooks_ts";
exports.ids = ["_rsc_server_services_submissionHooks_ts"];
exports.modules = {

/***/ "(rsc)/./server/services/calculationService.ts":
/*!***********************************************!*\
  !*** ./server/services/calculationService.ts ***!
  \***********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   CalculationService: () => (/* binding */ CalculationService)\n/* harmony export */ });\n/**\r\n * Calculation Service\r\n * \r\n * Centralized service for all campaign and submission calculations.\r\n * This is the SINGLE SOURCE OF TRUTH for all calculation logic.\r\n */ class CalculationService {\n    static{\n        this.VIEW_POINT_MULTIPLIER = 0.01;\n    }\n    static{\n        this.LIKE_POINT_MULTIPLIER = 0.5;\n    }\n    static{\n        this.SHARE_POINT_MULTIPLIER = 1.0;\n    }\n    static{\n        this.MAX_SHARE_PERCENT = 0.40 // Robin Hood cap\n        ;\n    }\n    static{\n        this.MAX_CAPPED_USERS = 2 // Only 2 users can reach 40%\n        ;\n    }\n    /**\r\n     * Calculate points from engagement metrics\r\n     */ static calculatePoints(views, likes, shares) {\n        const viewPoints = views * this.VIEW_POINT_MULTIPLIER;\n        const likePoints = likes * this.LIKE_POINT_MULTIPLIER;\n        const sharePoints = shares * this.SHARE_POINT_MULTIPLIER;\n        const totalPoints = viewPoints + likePoints + sharePoints;\n        return {\n            viewPoints,\n            likePoints,\n            sharePoints,\n            totalPoints\n        };\n    }\n    /**\r\n     * Calculate share percentage with Robin Hood cap\r\n     */ static calculateSharePercent(myPoints, totalCampaignPoints) {\n        if (totalCampaignPoints === 0 || myPoints === 0) return 0;\n        let sharePercent = myPoints / totalCampaignPoints;\n        // Apply Robin Hood cap - no one can earn more than 40%\n        if (sharePercent > this.MAX_SHARE_PERCENT) {\n            sharePercent = this.MAX_SHARE_PERCENT;\n        }\n        return sharePercent;\n    }\n    /**\r\n     * Calculate net budget after fees\r\n     */ static calculateNetBudget(totalBudget, platformFeePercent, safetyReservePercent) {\n        const netMultiplier = (100 - platformFeePercent - safetyReservePercent) / 100;\n        const netBudgetTP = totalBudget * 10 * netMultiplier;\n        return {\n            netBudgetTP,\n            netMultiplier\n        };\n    }\n    /**\r\n     * Calculate estimated earnings for a submission\r\n     */ static calculateEstimatedEarnings(myPoints, totalCampaignPoints, netBudgetTP) {\n        const sharePercent = this.calculateSharePercent(myPoints, totalCampaignPoints);\n        return netBudgetTP * sharePercent;\n    }\n    /**\r\n     * Update submission with calculated values\r\n     */ static async updateSubmissionCalculations(submissionId, prisma, tx // Optional transaction context\n    ) {\n        const db = tx || prisma; // Use transaction if provided\n        const submission = await db.submission.findUnique({\n            where: {\n                id: submissionId\n            },\n            include: {\n                campaign: {\n                    include: {\n                        poolStats: true\n                    }\n                }\n            }\n        });\n        if (!submission) throw new Error(\"Submission not found\");\n        // Calculate points\n        const points = this.calculatePoints(submission.lastViewCount || 0, submission.lastLikeCount || 0, submission.lastShareCount || 0);\n        // Calculate net budget\n        const { netBudgetTP } = this.calculateNetBudget(Number(submission.campaign.totalBudget), submission.campaign.platformFeePercent, submission.campaign.safetyReservePercent);\n        // Only update points here - share percentages will be calculated\n        // by recalculateCampaignSubmissions() with proper redistribution\n        await db.submission.update({\n            where: {\n                id: submissionId\n            },\n            data: {\n                viewPoints: points.viewPoints,\n                likePoints: points.likePoints,\n                sharePoints: points.sharePoints,\n                totalPoints: points.totalPoints\n            }\n        });\n        return {\n            points,\n            sharePercent: 0,\n            estimatedEarnings: 0\n        };\n    }\n    /**\r\n     * Update campaign's total points and recalculate all submissions\r\n     */ static async updateCampaignTotalPoints(campaignId, prisma, tx // Optional transaction context\n    ) {\n        const db = tx || prisma;\n        // Aggregate total points from all approved submissions\n        const totalPoints = await db.submission.aggregate({\n            where: {\n                campaignId,\n                status: \"APPROVED\"\n            },\n            _sum: {\n                totalPoints: true\n            },\n            _count: true\n        });\n        const totalCampaignPoints = totalPoints._sum.totalPoints || 0;\n        const totalSubmissions = totalPoints._count;\n        const averagePoints = totalSubmissions > 0 ? totalCampaignPoints / totalSubmissions : 0;\n        // Update or create pool stats\n        await db.campaignPoolStats.upsert({\n            where: {\n                campaignId\n            },\n            create: {\n                campaignId,\n                totalCampaignPoints,\n                totalSubmissions,\n                averagePoints\n            },\n            update: {\n                totalCampaignPoints,\n                totalSubmissions,\n                averagePoints\n            }\n        });\n        // Also update campaign's direct fields\n        await db.campaign.update({\n            where: {\n                id: campaignId\n            },\n            data: {\n                totalCampaignPoints\n            }\n        });\n        return {\n            totalCampaignPoints,\n            totalSubmissions,\n            averagePoints\n        };\n    }\n    /**\r\n     * Recalculate all submissions for a campaign with proper Robin Hood redistribution\r\n     */ static async recalculateCampaignSubmissions(campaignId, prisma, tx // Optional transaction context\n    ) {\n        const db = tx || prisma;\n        const campaign = await db.campaign.findUnique({\n            where: {\n                id: campaignId\n            },\n            include: {\n                poolStats: true,\n                submissions: {\n                    where: {\n                        status: \"APPROVED\"\n                    }\n                }\n            }\n        });\n        if (!campaign) return {\n            recalculated: 0\n        };\n        const submissions = campaign.submissions;\n        if (submissions.length === 0) return {\n            recalculated: 0\n        };\n        const totalCampaignPoints = campaign.poolStats?.totalCampaignPoints || 0;\n        if (totalCampaignPoints === 0) return {\n            recalculated: 0\n        };\n        // Calculate net budget\n        const { netBudgetTP } = this.calculateNetBudget(Number(campaign.totalBudget), campaign.platformFeePercent, campaign.safetyReservePercent);\n        // Step 1: Calculate raw percentages for all submissions\n        const submissionData = submissions.map((sub)=>({\n                id: sub.id,\n                points: sub.totalPoints || 0,\n                rawPercent: (sub.totalPoints || 0) / totalCampaignPoints\n            }));\n        // Step 2: Apply Robin Hood cap and redistribute iteratively\n        const finalShares = [];\n        // Iterative redistribution to ensure exactly 100%\n        let working = submissionData.map((sub)=>({\n                id: sub.id,\n                points: sub.points,\n                sharePercent: sub.rawPercent,\n                isCapped: false\n            }));\n        let iterations = 0;\n        const MAX_ITERATIONS = 10; // Prevent infinite loops\n        while(iterations < MAX_ITERATIONS){\n            iterations++;\n            // Count how many users are already capped at 40%\n            const cappedCount = working.filter((sub)=>sub.isCapped).length;\n            // Cap anyone over 40%, but respect max capped users limit\n            let hasNewCaps = false;\n            for (const sub of working){\n                if (!sub.isCapped && sub.sharePercent > this.MAX_SHARE_PERCENT) {\n                    // Only allow cap if we haven't hit the limit of 2 max earners\n                    if (cappedCount < this.MAX_CAPPED_USERS) {\n                        sub.sharePercent = this.MAX_SHARE_PERCENT;\n                        sub.isCapped = true;\n                        hasNewCaps = true;\n                    } else {\n                        // Already have 2 capped users, cap this one just below 40%\n                        sub.sharePercent = this.MAX_SHARE_PERCENT - 0.0001; // 39.99%\n                        sub.isCapped = true; // Mark as capped to prevent redistribution\n                        hasNewCaps = true;\n                    }\n                }\n            }\n            // Calculate current total\n            const currentTotal = working.reduce((sum, sub)=>sum + sub.sharePercent, 0);\n            // If we're at 100% (within floating point tolerance), we're done\n            if (Math.abs(currentTotal - 1.0) < 0.0001) {\n                break;\n            }\n            // If total < 100% and there are uncapped submissions, redistribute\n            if (currentTotal < 1.0) {\n                const excess = 1.0 - currentTotal;\n                const uncapped = working.filter((sub)=>!sub.isCapped);\n                if (uncapped.length === 0) {\n                    // All capped but total < 100% - distribute equally among all (edge case)\n                    const perSubmission = excess / working.length;\n                    for (const sub of working){\n                        sub.sharePercent += perSubmission;\n                    }\n                    break;\n                } else {\n                    // Redistribute proportionally among uncapped\n                    const uncappedTotal = uncapped.reduce((sum, sub)=>sum + sub.sharePercent, 0);\n                    for (const sub of working){\n                        if (!sub.isCapped && uncappedTotal > 0) {\n                            const additionalShare = sub.sharePercent / uncappedTotal * excess;\n                            sub.sharePercent += additionalShare;\n                        }\n                    }\n                }\n            } else {\n                break;\n            }\n            // If no new caps were added in this iteration and we just redistributed, we're done\n            if (!hasNewCaps) {\n                break;\n            }\n        }\n        // Build final shares\n        for (const sub of working){\n            finalShares.push({\n                id: sub.id,\n                sharePercent: sub.sharePercent,\n                estimatedEarnings: netBudgetTP * sub.sharePercent\n            });\n        }\n        // Step 3: Update all submissions with final shares AND totalEarnings\n        for (const share of finalShares){\n            const earningsTL = share.estimatedEarnings / 10; // Convert to TL\n            await db.submission.update({\n                where: {\n                    id: share.id\n                },\n                data: {\n                    sharePercent: share.sharePercent,\n                    estimatedEarnings: earningsTL,\n                    totalEarnings: earningsTL // Set totalEarnings here\n                }\n            });\n        }\n        return {\n            recalculated: finalShares.length\n        };\n    }\n    /**\r\n     * Initialize campaign calculations (call when campaign is created)\r\n     */ static async initializeCampaign(campaignId, prisma) {\n        const campaign = await prisma.campaign.findUnique({\n            where: {\n                id: campaignId\n            }\n        });\n        if (!campaign) throw new Error(\"Campaign not found\");\n        // Calculate net budget\n        const { netBudgetTP, netMultiplier } = this.calculateNetBudget(Number(campaign.totalBudget), campaign.platformFeePercent, campaign.safetyReservePercent);\n        // Update campaign with calculated values\n        await prisma.campaign.update({\n            where: {\n                id: campaignId\n            },\n            data: {\n                netBudgetTP,\n                netMultiplier,\n                totalCampaignPoints: 0\n            }\n        });\n        // Create pool stats\n        await prisma.campaignPoolStats.create({\n            data: {\n                campaignId,\n                totalCampaignPoints: 0,\n                totalSubmissions: 0,\n                averagePoints: 0\n            }\n        });\n        return {\n            netBudgetTP,\n            netMultiplier\n        };\n    }\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9zZXJ2ZXIvc2VydmljZXMvY2FsY3VsYXRpb25TZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7QUFFQTs7Ozs7Q0FLQyxHQUNNLE1BQU1BOzthQUNlQyx3QkFBd0I7OzthQUN4QkMsd0JBQXdCOzs7YUFDeEJDLHlCQUF5Qjs7O2FBQ3pCQyxvQkFBb0IsS0FBTSxpQkFBaUI7Ozs7YUFDM0NDLG1CQUFtQixFQUFHLDZCQUE2Qjs7O0lBRTNFOztLQUVDLEdBQ0QsT0FBT0MsZ0JBQWdCQyxLQUFhLEVBQUVDLEtBQWEsRUFBRUMsTUFBYyxFQUFFO1FBQ2pFLE1BQU1DLGFBQWFILFFBQVEsSUFBSSxDQUFDTixxQkFBcUI7UUFDckQsTUFBTVUsYUFBYUgsUUFBUSxJQUFJLENBQUNOLHFCQUFxQjtRQUNyRCxNQUFNVSxjQUFjSCxTQUFTLElBQUksQ0FBQ04sc0JBQXNCO1FBQ3hELE1BQU1VLGNBQWNILGFBQWFDLGFBQWFDO1FBRTlDLE9BQU87WUFBRUY7WUFBWUM7WUFBWUM7WUFBYUM7UUFBWTtJQUM5RDtJQUVBOztLQUVDLEdBQ0QsT0FBT0Msc0JBQ0hDLFFBQWdCLEVBQ2hCQyxtQkFBMkIsRUFDckI7UUFDTixJQUFJQSx3QkFBd0IsS0FBS0QsYUFBYSxHQUFHLE9BQU87UUFFeEQsSUFBSUUsZUFBZUYsV0FBV0M7UUFFOUIsdURBQXVEO1FBQ3ZELElBQUlDLGVBQWUsSUFBSSxDQUFDYixpQkFBaUIsRUFBRTtZQUN2Q2EsZUFBZSxJQUFJLENBQUNiLGlCQUFpQjtRQUN6QztRQUVBLE9BQU9hO0lBQ1g7SUFFQTs7S0FFQyxHQUNELE9BQU9DLG1CQUNIQyxXQUFtQixFQUNuQkMsa0JBQTBCLEVBQzFCQyxvQkFBNEIsRUFDOUI7UUFDRSxNQUFNQyxnQkFBZ0IsQ0FBQyxNQUFNRixxQkFBcUJDLG9CQUFtQixJQUFLO1FBQzFFLE1BQU1FLGNBQWNKLGNBQWMsS0FBS0c7UUFFdkMsT0FBTztZQUFFQztZQUFhRDtRQUFjO0lBQ3hDO0lBRUE7O0tBRUMsR0FDRCxPQUFP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TSxZQUFZTCxNQUFNO1FBQUM7SUFDOUM7SUFFQTs7S0FFQyxHQUNELGFBQWEyQixtQkFDVHhDLFVBQWtCLEVBQ2xCcEIsTUFBb0IsRUFDdEI7UUFDRSxNQUFNUSxXQUFXLE1BQU1SLE9BQU9RLFFBQVEsQ0FBQ0osVUFBVSxDQUFDO1lBQzlDQyxPQUFPO2dCQUFFQyxJQUFJYztZQUFXO1FBQzVCO1FBRUEsSUFBSSxDQUFDWixVQUFVLE1BQU0sSUFBSUUsTUFBTTtRQUUvQix1QkFBdUI7UUFDdkIsTUFBTSxFQUFFZCxXQUFXLEVBQUVELGFBQWEsRUFBRSxHQUFHLElBQUksQ0FBQ0osa0JBQWtCLENBQzFEd0IsT0FBT1AsU0FBU2hCLFdBQVcsR0FDM0JnQixTQUFTZixrQkFBa0IsRUFDM0JlLFNBQVNkLG9CQUFvQjtRQUdqQyx5Q0FBeUM7UUFDekMsTUFBTU0sT0FBT1EsUUFBUSxDQUFDUSxNQUFNLENBQUM7WUFDekJYLE9BQU87Z0JBQUVDLElBQUljO1lBQVc7WUFDeEJILE1BQU07Z0JBQ0ZyQjtnQkFDQUQ7Z0JBQ0FOLHFCQUFxQjtZQUN6QjtRQUNKO1FBRUEsb0JBQW9CO1FBQ3BCLE1BQU1XLE9BQU8yQixpQkFBaUIsQ0FBQ0UsTUFBTSxDQUFDO1lBQ2xDWixNQUFNO2dCQUNGRztnQkFDQS9CLHFCQUFxQjtnQkFDckJvQyxrQkFBa0I7Z0JBQ2xCQyxlQUFlO1lBQ25CO1FBQ0o7UUFFQSxPQUFPO1lBQUU5QjtZQUFhRDtRQUFjO0lBQ3hDO0FBQ0oiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9zZXNhci13ZWIvLi9zZXJ2ZXIvc2VydmljZXMvY2FsY3VsYXRpb25TZXJ2aWNlLnRzP2U1ZDQiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUHJpc21hQ2xpZW50IH0gZnJvbSAnQHByaXNtYS9jbGllbnQnO1xyXG5cclxuLyoqXHJcbiAqIENhbGN1bGF0aW9uIFNlcnZpY2VcclxuICogXHJcbiAqIENlbnRyYWxpemVkIHNlcnZpY2UgZm9yIGFsbCBjYW1wYWlnbiBhbmQgc3VibWlzc2lvbiBjYWxjdWxhdGlvbnMuXHJcbiAqIFRoaXMgaXMgdGhlIFNJTkdMRSBTT1VSQ0UgT0YgVFJVVEggZm9yIGFsbCBjYWxjdWxhdGlvbiBsb2dpYy5cclxuICovXHJcbmV4cG9ydCBjbGFzcyBDYWxjdWxhdGlvblNlcnZpY2Uge1xyXG4gICAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgVklFV19QT0lOVF9NVUxUSVBMSUVSID0gMC4wMTtcclxuICAgIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IExJS0VfUE9JTlRfTVVMVElQTElFUiA9IDAuNTtcclxuICAgIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IFNIQVJFX1BPSU5UX01VTFRJUExJRVIgPSAxLjA7XHJcbiAgICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBNQVhfU0hBUkVfUEVSQ0VOVCA9IDAuNDA7IC8vIFJvYmluIEhvb2QgY2FwXHJcbiAgICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBNQVhfQ0FQUEVEX1VTRVJTID0gMjsgLy8gT25seSAyIHVzZXJzIGNhbiByZWFjaCA0MCVcclxuXHJcbiAgICAvKipcclxuICAgICAqIENhbGN1bGF0ZSBwb2ludHMgZnJvbSBlbmdhZ2VtZW50IG1ldHJpY3NcclxuICAgICAqL1xyXG4gICAgc3RhdGljIGNhbGN1bGF0ZVBvaW50cyh2aWV3czogbnVtYmVyLCBsaWtlczogbnVtYmVyLCBzaGFyZXM6IG51bWJlcikge1xyXG4gICAgICAgIGNvbnN0IHZpZXdQb2ludHMgPSB2aWV3cyAqIHRoaXMuVklFV19QT0lOVF9NVUxUSVBMSUVSO1xyXG4gICAgICAgIGNvbnN0IGxpa2VQb2ludHMgPSBsaWtlcyAqIHRoaXMuTElLRV9QT0lOVF9NVUxUSVBMSUVSO1xyXG4gICAgICAgIGNvbnN0IHNoYXJlUG9pbnRzID0gc2hhcmVzICogdGhpcy5TSEFSRV9QT0lOVF9NVUxUSVBMSUVSO1xyXG4gICAgICAgIGNvbnN0IHRvdGFsUG9pbnRzID0gdmlld1BvaW50cyArIGxpa2VQb2ludHMgKyBzaGFyZVBvaW50cztcclxuXHJcbiAgICAgICAgcmV0dXJuIHsgdmlld1BvaW50cywgbGlrZVBvaW50cywgc2hhcmVQb2ludHMsIHRvdGFsUG9pbnRzIH07XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBDYWxjdWxhdGUgc2hhcmUgcGVyY2VudGFnZSB3aXRoIFJvYmluIEhvb2QgY2FwXHJcbiAgICAgKi9cclxuICAgIHN0YXRpYyBjYWxjdWxhdGVTaGFyZVBlcmNlbnQoXHJcbiAgICAgICAgbXlQb2ludHM6IG51bWJlcixcclxuICAgICAgICB0b3RhbENhbXBhaWduUG9pbnRzOiBudW1iZXJcclxuICAgICk6IG51bWJlciB7XHJcbiAgICAgICAgaWYgKHRvdGFsQ2FtcGFpZ25Qb2ludHMgPT09IDAgfHwgbXlQb2ludHMgPT09IDApIHJldHVybiAwO1xyXG5cclxuICAgICAgICBsZXQgc2hhcmVQZXJjZW50ID0gbXlQb2ludHMgLyB0b3RhbENhbXBhaWduUG9pbnRzO1xyXG5cclxuICAgICAgICAvLyBBcHBseSBSb2JpbiBIb29kIGNhcCAtIG5vIG9uZSBjYW4gZWFybiBtb3JlIHRoYW4gNDAlXHJcbiAgICAgICAgaWYgKHNoYXJlUGVyY2VudCA+IHRoaXMuTUFYX1NIQVJFX1BFUkNFTlQpIHtcclxuICAgICAgICAgICAgc2hhcmVQZXJjZW50ID0gdGhpcy5NQVhfU0hBUkVfUEVSQ0VOVDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBzaGFyZVBlcmNlbnQ7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBDYWxjdWxhdGUgbmV0IGJ1ZGdldCBhZnRlciBmZWVzXHJcbiAgICAgKi9cclxuICAgIHN0YXRpYyBjYWxjdWxhdGVOZXRCdWRnZXQoXHJcbiAgICAgICAgdG90YWxCdWRnZXQ6IG51bWJlcixcclxuICAgICAgICBwbGF0Zm9ybUZlZVBlcmNlbnQ6IG51bWJlcixcclxuICAgICAgICBzYWZldHlSZXNlcnZlUGVyY2VudDogbnVtYmVyXHJcbiAgICApIHtcclxuICAgICAgICBjb25zdCBuZXRNdWx0aXBsaWVyID0gKDEwMCAtIHBsYXRmb3JtRmVlUGVyY2VudCAtIHNhZmV0eVJlc2VydmVQZXJjZW50KSAvIDEwMDtcclxuICAgICAgICBjb25zdCBuZXRCdWRnZXRUUCA9IHRvdGFsQnVkZ2V0ICogMTAgKiBuZXRNdWx0aXBsaWVyO1xyXG5cclxuICAgICAgICByZXR1cm4geyBuZXRCdWRnZXRUUCwgbmV0TXVsdGlwbGllciB9O1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQ2FsY3VsYXRlIGVzdGltYXRlZCBlYXJuaW5ncyBmb3IgYSBzdWJtaXNzaW9uXHJcbiAgICAgKi9cclxuICAgIHN0YXRpYyBjYWxjdWxhdGVFc3RpbWF0ZWRFYXJuaW5ncyhcclxuICAgICAgICBteVBvaW50czogbnVtYmVyLFxyXG4gICAgICAgIHRvdGFsQ2FtcGFpZ25Qb2ludHM6IG51bWJlcixcclxuICAgICAgICBuZXRCdWRnZXRUUDogbnVtYmVyXHJcbiAgICApOiBudW1iZXIge1xyXG4gICAgICAgIGNvbnN0IHNoYXJlUGVyY2VudCA9IHRoaXMuY2FsY3VsYXRlU2hhcmVQZXJjZW50KG15UG9pbnRzLCB0b3RhbENhbXBhaWduUG9pbnRzKTtcclxuICAgICAgICByZXR1cm4gbmV0QnVkZ2V0VFAgKiBzaGFyZVBlcmNlbnQ7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBVcGRhdGUgc3VibWlzc2lvbiB3aXRoIGNhbGN1bGF0ZWQgdmFsdWVzXHJcbiAgICAgKi9cclxuICAgIHN0YXRpYyBhc3luYyB1cGRhdGVTdWJtaXNzaW9uQ2FsY3VsYXRpb25zKFxyXG4gICAgICAgIHN1Ym1pc3Npb25JZDogc3RyaW5nLFxyXG4gICAgICAgIHByaXNtYTogUHJpc21hQ2xpZW50LFxyXG4gICAgICAgIHR4PzogYW55IC8vIE9wdGlvbmFsIHRyYW5zYWN0aW9uIGNvbnRleHRcclxuICAgICkge1xyXG4gICAgICAgIGNvbnN0IGRiID0gdHggfHwgcHJpc21hOyAvLyBVc2UgdHJhbnNhY3Rpb24gaWYgcHJvdmlkZWRcclxuXHJcbiAgICAgICAgY29uc3Qgc3VibWlzc2lvbiA9IGF3YWl0IGRiLnN1Ym1pc3Npb24uZmluZFVuaXF1ZSh7XHJcbiAgICAgICAgICAgIHdoZXJlOiB7IGlkOiBzdWJtaXNzaW9uSWQgfSxcclxuICAgICAgICAgICAgaW5jbHVkZToge1xyXG4gICAgICAgICAgICAgICAgY2FtcGFpZ246IHtcclxuICAgICAgICAgICAgICAgICAgICBpbmNsdWRlOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBvb2xTdGF0czogdHJ1ZVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpZiAoIXN1Ym1pc3Npb24pIHRocm93IG5ldyBFcnJvcignU3VibWlzc2lvbiBub3QgZm91bmQnKTtcclxuXHJcbiAgICAgICAgLy8gQ2FsY3VsYXRlIHBvaW50c1xyXG4gICAgICAgIGNvbnN0IHBvaW50cyA9IHRoaXMuY2FsY3VsYXRlUG9pbnRzKFxyXG4gICAgICAgICAgICBzdWJtaXNzaW9uLmxhc3RWaWV3Q291bnQgfHwgMCxcclxuICAgICAgICAgICAgc3VibWlzc2lvbi5sYXN0TGlrZUNvdW50IHx8IDAsXHJcbiAgICAgICAgICAgIHN1Ym1pc3Npb24ubGFzdFNoYXJlQ291bnQgfHwgMFxyXG4gICAgICAgICk7XHJcblxyXG4gICAgICAgIC8vIENhbGN1bGF0ZSBuZXQgYnVkZ2V0XHJcbiAgICAgICAgY29uc3QgeyBuZXRCdWRnZXRUUCB9ID0gdGhpcy5jYWxjdWxhdGVOZXRCdWRnZXQoXHJcbiAgICAgICAgICAgIE51bWJlcihzdWJtaXNzaW9uLmNhbXBhaWduLnRvdGFsQnVkZ2V0KSxcclxuICAgICAgICAgICAgc3VibWlzc2lvbi5jYW1wYWlnbi5wbGF0Zm9ybUZlZVBlcmNlbnQsXHJcbiAgICAgICAgICAgIHN1Ym1pc3Npb24uY2FtcGFpZ24uc2FmZXR5UmVzZXJ2ZVBlcmNlbnRcclxuICAgICAgICApO1xyXG5cclxuICAgICAgICAvLyBPbmx5IHVwZGF0ZSBwb2ludHMgaGVyZSAtIHNoYXJlIHBlcmNlbnRhZ2VzIHdpbGwgYmUgY2FsY3VsYXRlZFxyXG4gICAgICAgIC8vIGJ5IHJlY2FsY3VsYXRlQ2FtcGFpZ25TdWJtaXNzaW9ucygpIHdpdGggcHJvcGVyIHJlZGlzdHJpYnV0aW9uXHJcbiAgICAgICAgYXdhaXQgZGIuc3VibWlzc2lvbi51cGRhdGUoe1xyXG4gICAgICAgICAgICB3aGVyZTogeyBpZDogc3VibWlzc2lvbklkIH0sXHJcbiAgICAgICAgICAgIGRhdGE6IHtcclxuICAgICAgICAgICAgICAgIHZpZXdQb2ludHM6IHBvaW50cy52aWV3UG9pbnRzLFxyXG4gICAgICAgICAgICAgICAgbGlrZVBvaW50czogcG9pbnRzLmxpa2VQb2ludHMsXHJcbiAgICAgICAgICAgICAgICBzaGFyZVBvaW50czogcG9pbnRzLnNoYXJlUG9pbnRzLFxyXG4gICAgICAgICAgICAgICAgdG90YWxQb2ludHM6IHBvaW50cy50b3RhbFBvaW50cyxcclxuICAgICAgICAgICAgICAgIC8vIERvbid0IHNldCBzaGFyZVBlcmNlbnQgb3IgZXN0aW1hdGVkRWFybmluZ3MgaGVyZVxyXG4gICAgICAgICAgICAgICAgLy8gVGhleSB3aWxsIGJlIGNhbGN1bGF0ZWQgd2l0aCBwcm9wZXIgcmVkaXN0cmlidXRpb25cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4geyBwb2ludHMsIHNoYXJlUGVyY2VudDogMCwgZXN0aW1hdGVkRWFybmluZ3M6IDAgfTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFVwZGF0ZSBjYW1wYWlnbidzIHRvdGFsIHBvaW50cyBhbmQgcmVjYWxjdWxhdGUgYWxsIHN1Ym1pc3Npb25zXHJcbiAgICAgKi9cclxuICAgIHN0YXRpYyBhc3luYyB1cGRhdGVDYW1wYWlnblRvdGFsUG9pbnRzKFxyXG4gICAgICAgIGNhbXBhaWduSWQ6IHN0cmluZyxcclxuICAgICAgICBwcmlzbWE6IFByaXNtYUNsaWVudCxcclxuICAgICAgICB0eD86IGFueSAvLyBPcHRpb25hbCB0cmFuc2FjdGlvbiBjb250ZXh0XHJcbiAgICApIHtcclxuICAgICAgICBjb25zdCBkYiA9IHR4IHx8IHByaXNtYTtcclxuXHJcbiAgICAgICAgLy8gQWdncmVnYXRlIHRvdGFsIHBvaW50cyBmcm9tIGFsbCBhcHByb3ZlZCBzdWJtaXNzaW9uc1xyXG4gICAgICAgIGNvbnN0IHRvdGFsUG9pbnRzID0gYXdhaXQgZGIuc3VibWlzc2lvbi5hZ2dyZWdhdGUoe1xyXG4gICAgICAgICAgICB3aGVyZTogeyBjYW1wYWlnbklkLCBzdGF0dXM6ICdBUFBST1ZFRCcgfSxcclxuICAgICAgICAgICAgX3N1bTogeyB0b3RhbFBvaW50czogdHJ1ZSB9LFxyXG4gICAgICAgICAgICBfY291bnQ6IHRydWVcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgY29uc3QgdG90YWxDYW1wYWlnblBvaW50cyA9IHRvdGFsUG9pbnRzLl9zdW0udG90YWxQb2ludHMgfHwgMDtcclxuICAgICAgICBjb25zdCB0b3RhbFN1Ym1pc3Npb25zID0gdG90YWxQb2ludHMuX2NvdW50O1xyXG4gICAgICAgIGNvbnN0IGF2ZXJhZ2VQb2ludHMgPSB0b3RhbFN1Ym1pc3Npb25zID4gMCA/IHRvdGFsQ2FtcGFpZ25Qb2ludHMgLyB0b3RhbFN1Ym1pc3Npb25zIDogMDtcclxuXHJcbiAgICAgICAgLy8gVXBkYXRlIG9yIGNyZWF0ZSBwb29sIHN0YXRzXHJcbiAgICAgICAgYXdhaXQgZGIuY2FtcGFpZ25Qb29sU3RhdHMudXBzZXJ0KHtcclxuICAgICAgICAgICAgd2hlcmU6IHsgY2FtcGFpZ25JZCB9LFxyXG4gICAgICAgICAgICBjcmVhdGU6IHtcclxuICAgICAgICAgICAgICAgIGNhbXBhaWduSWQsXHJcbiAgICAgICAgICAgICAgICB0b3RhbENhbXBhaWduUG9pbnRzLFxyXG4gICAgICAgICAgICAgICAgdG90YWxTdWJtaXNzaW9ucyxcclxuICAgICAgICAgICAgICAgIGF2ZXJhZ2VQb2ludHNcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgdXBkYXRlOiB7XHJcbiAgICAgICAgICAgICAgICB0b3RhbENhbXBhaWduUG9pbnRzLFxyXG4gICAgICAgICAgICAgICAgdG90YWxTdWJtaXNzaW9ucyxcclxuICAgICAgICAgICAgICAgIGF2ZXJhZ2VQb2ludHNcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvLyBBbHNvIHVwZGF0ZSBjYW1wYWlnbidzIGRpcmVjdCBmaWVsZHNcclxuICAgICAgICBhd2FpdCBkYi5jYW1wYWlnbi51cGRhdGUoe1xyXG4gICAgICAgICAgICB3aGVyZTogeyBpZDogY2FtcGFpZ25JZCB9LFxyXG4gICAgICAgICAgICBkYXRhOiB7IHRvdGFsQ2FtcGFpZ25Qb2ludHMgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4geyB0b3RhbENhbXBhaWduUG9pbnRzLCB0b3RhbFN1Ym1pc3Npb25zLCBhdmVyYWdlUG9pbnRzIH07XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBSZWNhbGN1bGF0ZSBhbGwgc3VibWlzc2lvbnMgZm9yIGEgY2FtcGFpZ24gd2l0aCBwcm9wZXIgUm9iaW4gSG9vZCByZWRpc3RyaWJ1dGlvblxyXG4gICAgICovXHJcbiAgICBzdGF0aWMgYXN5bmMgcmVjYWxjdWxhdGVDYW1wYWlnblN1Ym1pc3Npb25zKFxyXG4gICAgICAgIGNhbXBhaWduSWQ6IHN0cmluZyxcclxuICAgICAgICBwcmlzbWE6IFByaXNtYUNsaWVudCxcclxuICAgICAgICB0eD86IGFueSAvLyBPcHRpb25hbCB0cmFuc2FjdGlvbiBjb250ZXh0XHJcbiAgICApIHtcclxuICAgICAgICBjb25zdCBkYiA9IHR4IHx8IHByaXNtYTtcclxuXHJcbiAgICAgICAgY29uc3QgY2FtcGFpZ24gPSBhd2FpdCBkYi5jYW1wYWlnbi5maW5kVW5pcXVlKHtcclxuICAgICAgICAgICAgd2hlcmU6IHsgaWQ6IGNhbXBhaWduSWQgfSxcclxuICAgICAgICAgICAgaW5jbHVkZToge1xyXG4gICAgICAgICAgICAgICAgcG9vbFN0YXRzOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgc3VibWlzc2lvbnM6IHtcclxuICAgICAgICAgICAgICAgICAgICB3aGVyZTogeyBzdGF0dXM6ICdBUFBST1ZFRCcgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGlmICghY2FtcGFpZ24pIHJldHVybiB7IHJlY2FsY3VsYXRlZDogMCB9O1xyXG5cclxuICAgICAgICBjb25zdCBzdWJtaXNzaW9ucyA9IGNhbXBhaWduLnN1Ym1pc3Npb25zO1xyXG4gICAgICAgIGlmIChzdWJtaXNzaW9ucy5sZW5ndGggPT09IDApIHJldHVybiB7IHJlY2FsY3VsYXRlZDogMCB9O1xyXG5cclxuICAgICAgICBjb25zdCB0b3RhbENhbXBhaWduUG9pbnRzID0gY2FtcGFpZ24ucG9vbFN0YXRzPy50b3RhbENhbXBhaWduUG9pbnRzIHx8IDA7XHJcbiAgICAgICAgaWYgKHRvdGFsQ2FtcGFpZ25Qb2ludHMgPT09IDApIHJldHVybiB7IHJlY2FsY3VsYXRlZDogMCB9O1xyXG5cclxuICAgICAgICAvLyBDYWxjdWxhdGUgbmV0IGJ1ZGdldFxyXG4gICAgICAgIGNvbnN0IHsgbmV0QnVkZ2V0VFAgfSA9IHRoaXMuY2FsY3VsYXRlTmV0QnVkZ2V0KFxyXG4gICAgICAgICAgICBOdW1iZXIoY2FtcGFpZ24udG90YWxCdWRnZXQpLFxyXG4gICAgICAgICAgICBjYW1wYWlnbi5wbGF0Zm9ybUZlZVBlcmNlbnQsXHJcbiAgICAgICAgICAgIGNhbXBhaWduLnNhZmV0eVJlc2VydmVQZXJjZW50XHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgLy8gU3RlcCAxOiBDYWxjdWxhdGUgcmF3IHBlcmNlbnRhZ2VzIGZvciBhbGwgc3VibWlzc2lvbnNcclxuICAgICAgICBjb25zdCBzdWJtaXNzaW9uRGF0YSA9IHN1Ym1pc3Npb25zLm1hcChzdWIgPT4gKHtcclxuICAgICAgICAgICAgaWQ6IHN1Yi5pZCxcclxuICAgICAgICAgICAgcG9pbnRzOiBzdWIudG90YWxQb2ludHMgfHwgMCxcclxuICAgICAgICAgICAgcmF3UGVyY2VudDogKHN1Yi50b3RhbFBvaW50cyB8fCAwKSAvIHRvdGFsQ2FtcGFpZ25Qb2ludHNcclxuICAgICAgICB9KSk7XHJcblxyXG4gICAgICAgIC8vIFN0ZXAgMjogQXBwbHkgUm9iaW4gSG9vZCBjYXAgYW5kIHJlZGlzdHJpYnV0ZSBpdGVyYXRpdmVseVxyXG4gICAgICAgIGNvbnN0IGZpbmFsU2hhcmVzOiB7IGlkOiBzdHJpbmc7IHNoYXJlUGVyY2VudDogbnVtYmVyOyBlc3RpbWF0ZWRFYXJuaW5nczogbnVtYmVyIH1bXSA9IFtdO1xyXG5cclxuICAgICAgICAvLyBJdGVyYXRpdmUgcmVkaXN0cmlidXRpb24gdG8gZW5zdXJlIGV4YWN0bHkgMTAwJVxyXG4gICAgICAgIGxldCB3b3JraW5nID0gc3VibWlzc2lvbkRhdGEubWFwKHN1YiA9PiAoe1xyXG4gICAgICAgICAgICBpZDogc3ViLmlkLFxyXG4gICAgICAgICAgICBwb2ludHM6IHN1Yi5wb2ludHMsXHJcbiAgICAgICAgICAgIHNoYXJlUGVyY2VudDogc3ViLnJhd1BlcmNlbnQsXHJcbiAgICAgICAgICAgIGlzQ2FwcGVkOiBmYWxzZVxyXG4gICAgICAgIH0pKTtcclxuXHJcbiAgICAgICAgbGV0IGl0ZXJhdGlvbnMgPSAwO1xyXG4gICAgICAgIGNvbnN0IE1BWF9JVEVSQVRJT05TID0gMTA7IC8vIFByZXZlbnQgaW5maW5pdGUgbG9vcHNcclxuXHJcbiAgICAgICAgd2hpbGUgKGl0ZXJhdGlvbnMgPCBNQVhfSVRFUkFUSU9OUykge1xyXG4gICAgICAgICAgICBpdGVyYXRpb25zKys7XHJcblxyXG4gICAgICAgICAgICAvLyBDb3VudCBob3cgbWFueSB1c2VycyBhcmUgYWxyZWFkeSBjYXBwZWQgYXQgNDAlXHJcbiAgICAgICAgICAgIGNvbnN0IGNhcHBlZENvdW50ID0gd29ya2luZy5maWx0ZXIoc3ViID0+IHN1Yi5pc0NhcHBlZCkubGVuZ3RoO1xyXG5cclxuICAgICAgICAgICAgLy8gQ2FwIGFueW9uZSBvdmVyIDQwJSwgYnV0IHJlc3BlY3QgbWF4IGNhcHBlZCB1c2VycyBsaW1pdFxyXG4gICAgICAgICAgICBsZXQgaGFzTmV3Q2FwcyA9IGZhbHNlO1xyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IHN1YiBvZiB3b3JraW5nKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXN1Yi5pc0NhcHBlZCAmJiBzdWIuc2hhcmVQZXJjZW50ID4gdGhpcy5NQVhfU0hBUkVfUEVSQ0VOVCkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIE9ubHkgYWxsb3cgY2FwIGlmIHdlIGhhdmVuJ3QgaGl0IHRoZSBsaW1pdCBvZiAyIG1heCBlYXJuZXJzXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNhcHBlZENvdW50IDwgdGhpcy5NQVhfQ0FQUEVEX1VTRVJTKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN1Yi5zaGFyZVBlcmNlbnQgPSB0aGlzLk1BWF9TSEFSRV9QRVJDRU5UO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzdWIuaXNDYXBwZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBoYXNOZXdDYXBzID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBBbHJlYWR5IGhhdmUgMiBjYXBwZWQgdXNlcnMsIGNhcCB0aGlzIG9uZSBqdXN0IGJlbG93IDQwJVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzdWIuc2hhcmVQZXJjZW50ID0gdGhpcy5NQVhfU0hBUkVfUEVSQ0VOVCAtIDAuMDAwMTsgLy8gMzkuOTklXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN1Yi5pc0NhcHBlZCA9IHRydWU7IC8vIE1hcmsgYXMgY2FwcGVkIHRvIHByZXZlbnQgcmVkaXN0cmlidXRpb25cclxuICAgICAgICAgICAgICAgICAgICAgICAgaGFzTmV3Q2FwcyA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBDYWxjdWxhdGUgY3VycmVudCB0b3RhbFxyXG4gICAgICAgICAgICBjb25zdCBjdXJyZW50VG90YWwgPSB3b3JraW5nLnJlZHVjZSgoc3VtLCBzdWIpID0+IHN1bSArIHN1Yi5zaGFyZVBlcmNlbnQsIDApO1xyXG5cclxuICAgICAgICAgICAgLy8gSWYgd2UncmUgYXQgMTAwJSAod2l0aGluIGZsb2F0aW5nIHBvaW50IHRvbGVyYW5jZSksIHdlJ3JlIGRvbmVcclxuICAgICAgICAgICAgaWYgKE1hdGguYWJzKGN1cnJlbnRUb3RhbCAtIDEuMCkgPCAwLjAwMDEpIHtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBJZiB0b3RhbCA8IDEwMCUgYW5kIHRoZXJlIGFyZSB1bmNhcHBlZCBzdWJtaXNzaW9ucywgcmVkaXN0cmlidXRlXHJcbiAgICAgICAgICAgIGlmIChjdXJyZW50VG90YWwgPCAxLjApIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGV4Y2VzcyA9IDEuMCAtIGN1cnJlbnRUb3RhbDtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHVuY2FwcGVkID0gd29ya2luZy5maWx0ZXIoc3ViID0+ICFzdWIuaXNDYXBwZWQpO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmICh1bmNhcHBlZC5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBBbGwgY2FwcGVkIGJ1dCB0b3RhbCA8IDEwMCUgLSBkaXN0cmlidXRlIGVxdWFsbHkgYW1vbmcgYWxsIChlZGdlIGNhc2UpXHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGVyU3VibWlzc2lvbiA9IGV4Y2VzcyAvIHdvcmtpbmcubGVuZ3RoO1xyXG4gICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3Qgc3ViIG9mIHdvcmtpbmcpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3ViLnNoYXJlUGVyY2VudCArPSBwZXJTdWJtaXNzaW9uO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gUmVkaXN0cmlidXRlIHByb3BvcnRpb25hbGx5IGFtb25nIHVuY2FwcGVkXHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdW5jYXBwZWRUb3RhbCA9IHVuY2FwcGVkLnJlZHVjZSgoc3VtLCBzdWIpID0+IHN1bSArIHN1Yi5zaGFyZVBlcmNlbnQsIDApO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHN1YiBvZiB3b3JraW5nKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc3ViLmlzQ2FwcGVkICYmIHVuY2FwcGVkVG90YWwgPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhZGRpdGlvbmFsU2hhcmUgPSAoc3ViLnNoYXJlUGVyY2VudCAvIHVuY2FwcGVkVG90YWwpICogZXhjZXNzO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ViLnNoYXJlUGVyY2VudCArPSBhZGRpdGlvbmFsU2hhcmU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAvLyBUb3RhbCA+IDEwMCUgLSBzaG91bGRuJ3QgaGFwcGVuIGJ1dCBoYW5kbGUgaXRcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBJZiBubyBuZXcgY2FwcyB3ZXJlIGFkZGVkIGluIHRoaXMgaXRlcmF0aW9uIGFuZCB3ZSBqdXN0IHJlZGlzdHJpYnV0ZWQsIHdlJ3JlIGRvbmVcclxuICAgICAgICAgICAgaWYgKCFoYXNOZXdDYXBzKSB7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gQnVpbGQgZmluYWwgc2hhcmVzXHJcbiAgICAgICAgZm9yIChjb25zdCBzdWIgb2Ygd29ya2luZykge1xyXG4gICAgICAgICAgICBmaW5hbFNoYXJlcy5wdXNoKHtcclxuICAgICAgICAgICAgICAgIGlkOiBzdWIuaWQsXHJcbiAgICAgICAgICAgICAgICBzaGFyZVBlcmNlbnQ6IHN1Yi5zaGFyZVBlcmNlbnQsXHJcbiAgICAgICAgICAgICAgICBlc3RpbWF0ZWRFYXJuaW5nczogbmV0QnVkZ2V0VFAgKiBzdWIuc2hhcmVQZXJjZW50XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gU3RlcCAzOiBVcGRhdGUgYWxsIHN1Ym1pc3Npb25zIHdpdGggZmluYWwgc2hhcmVzIEFORCB0b3RhbEVhcm5pbmdzXHJcbiAgICAgICAgZm9yIChjb25zdCBzaGFyZSBvZiBmaW5hbFNoYXJlcykge1xyXG4gICAgICAgICAgICBjb25zdCBlYXJuaW5nc1RMID0gc2hhcmUuZXN0aW1hdGVkRWFybmluZ3MgLyAxMDsgLy8gQ29udmVydCB0byBUTFxyXG4gICAgICAgICAgICBhd2FpdCBkYi5zdWJtaXNzaW9uLnVwZGF0ZSh7XHJcbiAgICAgICAgICAgICAgICB3aGVyZTogeyBpZDogc2hhcmUuaWQgfSxcclxuICAgICAgICAgICAgICAgIGRhdGE6IHtcclxuICAgICAgICAgICAgICAgICAgICBzaGFyZVBlcmNlbnQ6IHNoYXJlLnNoYXJlUGVyY2VudCxcclxuICAgICAgICAgICAgICAgICAgICBlc3RpbWF0ZWRFYXJuaW5nczogZWFybmluZ3NUTCxcclxuICAgICAgICAgICAgICAgICAgICB0b3RhbEVhcm5pbmdzOiBlYXJuaW5nc1RMIC8vIFNldCB0b3RhbEVhcm5pbmdzIGhlcmVcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4geyByZWNhbGN1bGF0ZWQ6IGZpbmFsU2hhcmVzLmxlbmd0aCB9O1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogSW5pdGlhbGl6ZSBjYW1wYWlnbiBjYWxjdWxhdGlvbnMgKGNhbGwgd2hlbiBjYW1wYWlnbiBpcyBjcmVhdGVkKVxyXG4gICAgICovXHJcbiAgICBzdGF0aWMgYXN5bmMgaW5pdGlhbGl6ZUNhbXBhaWduKFxyXG4gICAgICAgIGNhbXBhaWduSWQ6IHN0cmluZyxcclxuICAgICAgICBwcmlzbWE6IFByaXNtYUNsaWVudFxyXG4gICAgKSB7XHJcbiAgICAgICAgY29uc3QgY2FtcGFpZ24gPSBhd2FpdCBwcmlzbWEuY2FtcGFpZ24uZmluZFVuaXF1ZSh7XHJcbiAgICAgICAgICAgIHdoZXJlOiB7IGlkOiBjYW1wYWlnbklkIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaWYgKCFjYW1wYWlnbikgdGhyb3cgbmV3IEVycm9yKCdDYW1wYWlnbiBub3QgZm91bmQnKTtcclxuXHJcbiAgICAgICAgLy8gQ2FsY3VsYXRlIG5ldCBidWRnZXRcclxuICAgICAgICBjb25zdCB7IG5ldEJ1ZGdldFRQLCBuZXRNdWx0aXBsaWVyIH0gPSB0aGlzLmNhbGN1bGF0ZU5ldEJ1ZGdldChcclxuICAgICAgICAgICAgTnVtYmVyKGNhbXBhaWduLnRvdGFsQnVkZ2V0KSxcclxuICAgICAgICAgICAgY2FtcGFpZ24ucGxhdGZvcm1GZWVQZXJjZW50LFxyXG4gICAgICAgICAgICBjYW1wYWlnbi5zYWZldHlSZXNlcnZlUGVyY2VudFxyXG4gICAgICAgICk7XHJcblxyXG4gICAgICAgIC8vIFVwZGF0ZSBjYW1wYWlnbiB3aXRoIGNhbGN1bGF0ZWQgdmFsdWVzXHJcbiAgICAgICAgYXdhaXQgcHJpc21hLmNhbXBhaWduLnVwZGF0ZSh7XHJcbiAgICAgICAgICAgIHdoZXJlOiB7IGlkOiBjYW1wYWlnbklkIH0sXHJcbiAgICAgICAgICAgIGRhdGE6IHtcclxuICAgICAgICAgICAgICAgIG5ldEJ1ZGdldFRQLFxyXG4gICAgICAgICAgICAgICAgbmV0TXVsdGlwbGllcixcclxuICAgICAgICAgICAgICAgIHRvdGFsQ2FtcGFpZ25Qb2ludHM6IDBcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvLyBDcmVhdGUgcG9vbCBzdGF0c1xyXG4gICAgICAgIGF3YWl0IHByaXNtYS5jYW1wYWlnblBvb2xTdGF0cy5jcmVhdGUoe1xyXG4gICAgICAgICAgICBkYXRhOiB7XHJcbiAgICAgICAgICAgICAgICBjYW1wYWlnbklkLFxyXG4gICAgICAgICAgICAgICAgdG90YWxDYW1wYWlnblBvaW50czogMCxcclxuICAgICAgICAgICAgICAgIHRvdGFsU3VibWlzc2lvbnM6IDAsXHJcbiAgICAgICAgICAgICAgICBhdmVyYWdlUG9pbnRzOiAwXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHsgbmV0QnVkZ2V0VFAsIG5ldE11bHRpcGxpZXIgfTtcclxuICAgIH1cclxufVxyXG4iXSwibmFtZXMiOlsiQ2FsY3VsYXRpb25TZXJ2aWNlIiwiVklFV19QT0lOVF9NVUxUSVBMSUVSIiwiTElLRV9QT0lOVF9NVUxUSVBMSUVSIiwiU0hBUkVfUE9JTlRfTVVMVElQTElFUiIsIk1BWF9TSEFSRV9QRVJDRU5UIiwiTUFYX0NBUFBFRF9VU0VSUyIsImNhbGN1bGF0ZVBvaW50cyIsInZpZXdzIiwibGlrZXMiLCJzaGFyZXMiLCJ2aWV3UG9pbnRzIiwibGlrZVBvaW50cyIsInNoYXJlUG9pbnRzIiwidG90YWxQb2ludHMiLCJjYWxjdWxhdGVTaGFyZVBlcmNlbnQiLCJteVBvaW50cyIsInRvdGFsQ2FtcGFpZ25Qb2ludHMiLCJzaGFyZVBlcmNlbnQiLCJjYWxjdWxhdGVOZXRCdWRnZXQiLCJ0b3RhbEJ1ZGdldCIsInBsYXRmb3JtRmVlUGVyY2VudCIsInNhZmV0eVJlc2VydmVQZXJjZW50IiwibmV0TXVsdGlwbGllciIsIm5ldEJ1ZGdldFRQIiwiY2FsY3VsYXRlRXN0aW1hdGVkRWFybmluZ3MiLCJ1cGRhdGVTdWJtaXNzaW9uQ2FsY3VsYXRpb25zIiwic3VibWlzc2lvbklkIiwicHJpc21hIiwidHgiLCJkYiIsInN1Ym1pc3Npb24iLCJmaW5kVW5pcXVlIiwid2hlcmUiLCJpZCIsImluY2x1ZGUiLCJjYW1wYWlnbiIsInBvb2xTdGF0cyIsIkVycm9yIiwicG9pbnRzIiwibGFzdFZpZXdDb3VudCIsImxhc3RMaWtlQ291bnQiLCJsYXN0U2hhcmVDb3VudCIsIk51bWJlciIsInVwZGF0ZSIsImRhdGEiLCJlc3RpbWF0ZWRFYXJuaW5ncyIsInVwZGF0ZUNhbXBhaWduVG90YWxQb2ludHMiLCJjYW1wYWlnbklkIiwiYWdncmVnYXRlIiwic3RhdHVzIiwiX3N1bSIsIl9jb3VudCIsInRvdGFsU3VibWlzc2lvbnMiLCJhdmVyYWdlUG9pbnRzIiwiY2FtcGFpZ25Qb29sU3RhdHMiLCJ1cHNlcnQiLCJjcmVhdGUiLCJyZWNhbGN1bGF0ZUNhbXBhaWduU3VibWlzc2lvbnMiLCJzdWJtaXNzaW9ucyIsInJlY2FsY3VsYXRlZCIsImxlbmd0aCIsInN1Ym1pc3Npb25EYXRhIiwibWFwIiwic3ViIiwicmF3UGVyY2VudCIsImZpbmFsU2hhcmVzIiwid29ya2luZyIsImlzQ2FwcGVkIiwiaXRlcmF0aW9ucyIsIk1BWF9JVEVSQVRJT05TIiwiY2FwcGVkQ291bnQiLCJmaWx0ZXIiLCJoYXNOZXdDYXBzIiwiY3VycmVudFRvdGFsIiwicmVkdWNlIiwic3VtIiwiTWF0aCIsImFicyIsImV4Y2VzcyIsInVuY2FwcGVkIiwicGVyU3VibWlzc2lvbiIsInVuY2FwcGVkVG90YWwiLCJhZGRpdGlvbmFsU2hhcmUiLCJwdXNoIiwic2hhcmUiLCJlYXJuaW5nc1RMIiwidG90YWxFYXJuaW5ncyIsImluaXRpYWxpemVDYW1wYWlnbiJdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///(rsc)/./server/services/calculationService.ts\n");

/***/ }),

/***/ "(rsc)/./server/services/submissionHooks.ts":
/*!********************************************!*\
  !*** ./server/services/submissionHooks.ts ***!
  \********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   onCampaignCreated: () => (/* binding */ onCampaignCreated),\n/* harmony export */   onSubmissionApproved: () => (/* binding */ onSubmissionApproved),\n/* harmony export */   onSubmissionRejected: () => (/* binding */ onSubmissionRejected),\n/* harmony export */   onSubmissionStatsUpdate: () => (/* binding */ onSubmissionStatsUpdate)\n/* harmony export */ });\n/* harmony import */ var _calculationService__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./calculationService */ \"(rsc)/./server/services/calculationService.ts\");\n\n/**\r\n * Submission Hooks\r\n * \r\n * Automatic triggers for recalculating submission and campaign statistics\r\n * when submission data changes.\r\n */ /**\r\n * Hook to recalculate when submission stats are updated\r\n * Call this after updating lastViewCount, lastLikeCount, or lastShareCount\r\n */ async function onSubmissionStatsUpdate(submissionId, prisma) {\n    // 1. Recalculate this submission's points and earnings\n    await _calculationService__WEBPACK_IMPORTED_MODULE_0__.CalculationService.updateSubmissionCalculations(submissionId, prisma);\n    // 2. Get the campaign ID\n    const submission = await prisma.submission.findUnique({\n        where: {\n            id: submissionId\n        },\n        select: {\n            campaignId: true\n        }\n    });\n    if (submission) {\n        // 3. Update campaign's total points\n        await updateCampaignTotalPoints(submission.campaignId, prisma);\n    }\n}\n/**\r\n * Update campaign's total points and recalculate all submissions\r\n * This ensures all submissions have the correct share percentage\r\n */ async function updateCampaignTotalPoints(campaignId, prisma) {\n    // 1. Aggregate total points from all approved submissions\n    const stats = await _calculationService__WEBPACK_IMPORTED_MODULE_0__.CalculationService.updateCampaignTotalPoints(campaignId, prisma);\n    // 2. Recalculate all submissions with the new total\n    // This is important because share percentage depends on total campaign points\n    await _calculationService__WEBPACK_IMPORTED_MODULE_0__.CalculationService.recalculateCampaignSubmissions(campaignId, prisma);\n    return stats;\n}\n/**\r\n * Hook to call when a submission is approved\r\n * This triggers recalculation for the entire campaign\r\n */ async function onSubmissionApproved(submissionId, prisma) {\n    // First calculate this submission\n    await _calculationService__WEBPACK_IMPORTED_MODULE_0__.CalculationService.updateSubmissionCalculations(submissionId, prisma);\n    // Then update campaign totals and recalculate all submissions\n    const submission = await prisma.submission.findUnique({\n        where: {\n            id: submissionId\n        },\n        select: {\n            campaignId: true\n        }\n    });\n    if (submission) {\n        await updateCampaignTotalPoints(submission.campaignId, prisma);\n    }\n}\n/**\r\n * Hook to call when a submission is rejected\r\n * This triggers recalculation for the entire campaign\r\n */ async function onSubmissionRejected(submissionId, prisma) {\n    const submission = await prisma.submission.findUnique({\n        where: {\n            id: submissionId\n        },\n        select: {\n            campaignId: true\n        }\n    });\n    if (submission) {\n        // Recalculate campaign totals (excluding this rejected submission)\n        await updateCampaignTotalPoints(submission.campaignId, prisma);\n    }\n}\n/**\r\n * Hook to call when a campaign is created\r\n * Initializes the campaign's calculated fields\r\n */ async function onCampaignCreated(campaignId, prisma) {\n    await _calculationService__WEBPACK_IMPORTED_MODULE_0__.CalculationService.initializeCampaign(campaignId, prisma);\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9zZXJ2ZXIvc2VydmljZXMvc3VibWlzc2lvbkhvb2tzLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQzBEO0FBRTFEOzs7OztDQUtDLEdBRUQ7OztDQUdDLEdBQ00sZUFBZUMsd0JBQ2xCQyxZQUFvQixFQUNwQkMsTUFBb0I7SUFFcEIsdURBQXVEO0lBQ3ZELE1BQU1ILG1FQUFrQkEsQ0FBQ0ksNEJBQTRCLENBQUNGLGNBQWNDO0lBRXBFLHlCQUF5QjtJQUN6QixNQUFNRSxhQUFhLE1BQU1GLE9BQU9FLFVBQVUsQ0FBQ0MsVUFBVSxDQUFDO1FBQ2xEQyxPQUFPO1lBQUVDLElBQUlOO1FBQWE7UUFDMUJPLFFBQVE7WUFBRUMsWUFBWTtRQUFLO0lBQy9CO0lBRUEsSUFBSUwsWUFBWTtRQUNaLG9DQUFvQztRQUNwQyxNQUFNTSwwQkFBMEJOLFdBQVdLLFVBQVUsRUFBRVA7SUFDM0Q7QUFDSjtBQUVBOzs7Q0FHQyxHQUNELGVBQWVRLDBCQUNYRCxVQUFrQixFQUNsQlAsTUFBb0I7SUFFcEIsMERBQTBEO0lBQzFELE1BQU1TLFFBQVEsTUFBTVosbUVBQWtCQSxDQUFDVyx5QkFBeUIsQ0FBQ0QsWUFBWVA7SUFFN0Usb0RBQW9EO0lBQ3BELDhFQUE4RTtJQUM5RSxNQUFNSCxtRUFBa0JBLENBQUNhLDhCQUE4QixDQUFDSCxZQUFZUDtJQUVwRSxPQUFPUztBQUNYO0FBRUE7OztDQUdDLEdBQ00sZUFBZUUscUJBQ2xCWixZQUFvQixFQUNwQkMsTUFBb0I7SUFFcEIsa0NBQWtDO0lBQ2xDLE1BQU1ILG1FQUFrQkEsQ0FBQ0ksNEJBQTRCLENBQUNGLGNBQWNDO0lBRXBFLDhEQUE4RDtJQUM5RCxNQUFNRSxhQUFhLE1BQU1GLE9BQU9FLFVBQVUsQ0FBQ0MsVUFBVSxDQUFDO1FBQ2xEQyxPQUFPO1lBQUVDLElBQUlOO1FBQWE7UUFDMUJPLFFBQVE7WUFBRUMsWUFBWTtRQUFLO0lBQy9CO0lBRUEsSUFBSUwsWUFBWTtRQUNaLE1BQU1NLDBCQUEwQk4sV0FBV0ssVUFBVSxFQUFFUDtJQUMzRDtBQUNKO0FBRUE7OztDQUdDLEdBQ00sZUFBZVkscUJBQ2xCYixZQUFvQixFQUNwQkMsTUFBb0I7SUFFcEIsTUFBTUUsYUFBYSxNQUFNRixPQUFPRSxVQUFVLENBQUNDLFVBQVUsQ0FBQztRQUNsREMsT0FBTztZQUFFQyxJQUFJTjtRQUFhO1FBQzFCTyxRQUFRO1lBQUVDLFlBQVk7UUFBSztJQUMvQjtJQUVBLElBQUlMLFlBQVk7UUFDWixtRUFBbUU7UUFDbkUsTUFBTU0sMEJBQTBCTixXQUFXSyxVQUFVLEVBQUVQO0lBQzNEO0FBQ0o7QUFFQTs7O0NBR0MsR0FDTSxlQUFlYSxrQkFDbEJOLFVBQWtCLEVBQ2xCUCxNQUFvQjtJQUVwQixNQUFNSCxtRUFBa0JBLENBQUNpQixrQkFBa0IsQ0FBQ1AsWUFBWVA7QUFDNUQiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9zZXNhci13ZWIvLi9zZXJ2ZXIvc2VydmljZXMvc3VibWlzc2lvbkhvb2tzLnRzP2MyNzYiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUHJpc21hQ2xpZW50IH0gZnJvbSAnQHByaXNtYS9jbGllbnQnO1xyXG5pbXBvcnQgeyBDYWxjdWxhdGlvblNlcnZpY2UgfSBmcm9tICcuL2NhbGN1bGF0aW9uU2VydmljZSc7XHJcblxyXG4vKipcclxuICogU3VibWlzc2lvbiBIb29rc1xyXG4gKiBcclxuICogQXV0b21hdGljIHRyaWdnZXJzIGZvciByZWNhbGN1bGF0aW5nIHN1Ym1pc3Npb24gYW5kIGNhbXBhaWduIHN0YXRpc3RpY3NcclxuICogd2hlbiBzdWJtaXNzaW9uIGRhdGEgY2hhbmdlcy5cclxuICovXHJcblxyXG4vKipcclxuICogSG9vayB0byByZWNhbGN1bGF0ZSB3aGVuIHN1Ym1pc3Npb24gc3RhdHMgYXJlIHVwZGF0ZWRcclxuICogQ2FsbCB0aGlzIGFmdGVyIHVwZGF0aW5nIGxhc3RWaWV3Q291bnQsIGxhc3RMaWtlQ291bnQsIG9yIGxhc3RTaGFyZUNvdW50XHJcbiAqL1xyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gb25TdWJtaXNzaW9uU3RhdHNVcGRhdGUoXHJcbiAgICBzdWJtaXNzaW9uSWQ6IHN0cmluZyxcclxuICAgIHByaXNtYTogUHJpc21hQ2xpZW50XHJcbikge1xyXG4gICAgLy8gMS4gUmVjYWxjdWxhdGUgdGhpcyBzdWJtaXNzaW9uJ3MgcG9pbnRzIGFuZCBlYXJuaW5nc1xyXG4gICAgYXdhaXQgQ2FsY3VsYXRpb25TZXJ2aWNlLnVwZGF0ZVN1Ym1pc3Npb25DYWxjdWxhdGlvbnMoc3VibWlzc2lvbklkLCBwcmlzbWEpO1xyXG5cclxuICAgIC8vIDIuIEdldCB0aGUgY2FtcGFpZ24gSURcclxuICAgIGNvbnN0IHN1Ym1pc3Npb24gPSBhd2FpdCBwcmlzbWEuc3VibWlzc2lvbi5maW5kVW5pcXVlKHtcclxuICAgICAgICB3aGVyZTogeyBpZDogc3VibWlzc2lvbklkIH0sXHJcbiAgICAgICAgc2VsZWN0OiB7IGNhbXBhaWduSWQ6IHRydWUgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgaWYgKHN1Ym1pc3Npb24pIHtcclxuICAgICAgICAvLyAzLiBVcGRhdGUgY2FtcGFpZ24ncyB0b3RhbCBwb2ludHNcclxuICAgICAgICBhd2FpdCB1cGRhdGVDYW1wYWlnblRvdGFsUG9pbnRzKHN1Ym1pc3Npb24uY2FtcGFpZ25JZCwgcHJpc21hKTtcclxuICAgIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIFVwZGF0ZSBjYW1wYWlnbidzIHRvdGFsIHBvaW50cyBhbmQgcmVjYWxjdWxhdGUgYWxsIHN1Ym1pc3Npb25zXHJcbiAqIFRoaXMgZW5zdXJlcyBhbGwgc3VibWlzc2lvbnMgaGF2ZSB0aGUgY29ycmVjdCBzaGFyZSBwZXJjZW50YWdlXHJcbiAqL1xyXG5hc3luYyBmdW5jdGlvbiB1cGRhdGVDYW1wYWlnblRvdGFsUG9pbnRzKFxyXG4gICAgY2FtcGFpZ25JZDogc3RyaW5nLFxyXG4gICAgcHJpc21hOiBQcmlzbWFDbGllbnRcclxuKSB7XHJcbiAgICAvLyAxLiBBZ2dyZWdhdGUgdG90YWwgcG9pbnRzIGZyb20gYWxsIGFwcHJvdmVkIHN1Ym1pc3Npb25zXHJcbiAgICBjb25zdCBzdGF0cyA9IGF3YWl0IENhbGN1bGF0aW9uU2VydmljZS51cGRhdGVDYW1wYWlnblRvdGFsUG9pbnRzKGNhbXBhaWduSWQsIHByaXNtYSk7XHJcblxyXG4gICAgLy8gMi4gUmVjYWxjdWxhdGUgYWxsIHN1Ym1pc3Npb25zIHdpdGggdGhlIG5ldyB0b3RhbFxyXG4gICAgLy8gVGhpcyBpcyBpbXBvcnRhbnQgYmVjYXVzZSBzaGFyZSBwZXJjZW50YWdlIGRlcGVuZHMgb24gdG90YWwgY2FtcGFpZ24gcG9pbnRzXHJcbiAgICBhd2FpdCBDYWxjdWxhdGlvblNlcnZpY2UucmVjYWxjdWxhdGVDYW1wYWlnblN1Ym1pc3Npb25zKGNhbXBhaWduSWQsIHByaXNtYSk7XHJcblxyXG4gICAgcmV0dXJuIHN0YXRzO1xyXG59XHJcblxyXG4vKipcclxuICogSG9vayB0byBjYWxsIHdoZW4gYSBzdWJtaXNzaW9uIGlzIGFwcHJvdmVkXHJcbiAqIFRoaXMgdHJpZ2dlcnMgcmVjYWxjdWxhdGlvbiBmb3IgdGhlIGVudGlyZSBjYW1wYWlnblxyXG4gKi9cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIG9uU3VibWlzc2lvbkFwcHJvdmVkKFxyXG4gICAgc3VibWlzc2lvbklkOiBzdHJpbmcsXHJcbiAgICBwcmlzbWE6IFByaXNtYUNsaWVudFxyXG4pIHtcclxuICAgIC8vIEZpcnN0IGNhbGN1bGF0ZSB0aGlzIHN1Ym1pc3Npb25cclxuICAgIGF3YWl0IENhbGN1bGF0aW9uU2VydmljZS51cGRhdGVTdWJtaXNzaW9uQ2FsY3VsYXRpb25zKHN1Ym1pc3Npb25JZCwgcHJpc21hKTtcclxuXHJcbiAgICAvLyBUaGVuIHVwZGF0ZSBjYW1wYWlnbiB0b3RhbHMgYW5kIHJlY2FsY3VsYXRlIGFsbCBzdWJtaXNzaW9uc1xyXG4gICAgY29uc3Qgc3VibWlzc2lvbiA9IGF3YWl0IHByaXNtYS5zdWJtaXNzaW9uLmZpbmRVbmlxdWUoe1xyXG4gICAgICAgIHdoZXJlOiB7IGlkOiBzdWJtaXNzaW9uSWQgfSxcclxuICAgICAgICBzZWxlY3Q6IHsgY2FtcGFpZ25JZDogdHJ1ZSB9XHJcbiAgICB9KTtcclxuXHJcbiAgICBpZiAoc3VibWlzc2lvbikge1xyXG4gICAgICAgIGF3YWl0IHVwZGF0ZUNhbXBhaWduVG90YWxQb2ludHMoc3VibWlzc2lvbi5jYW1wYWlnbklkLCBwcmlzbWEpO1xyXG4gICAgfVxyXG59XHJcblxyXG4vKipcclxuICogSG9vayB0byBjYWxsIHdoZW4gYSBzdWJtaXNzaW9uIGlzIHJlamVjdGVkXHJcbiAqIFRoaXMgdHJpZ2dlcnMgcmVjYWxjdWxhdGlvbiBmb3IgdGhlIGVudGlyZSBjYW1wYWlnblxyXG4gKi9cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIG9uU3VibWlzc2lvblJlamVjdGVkKFxyXG4gICAgc3VibWlzc2lvbklkOiBzdHJpbmcsXHJcbiAgICBwcmlzbWE6IFByaXNtYUNsaWVudFxyXG4pIHtcclxuICAgIGNvbnN0IHN1Ym1pc3Npb24gPSBhd2FpdCBwcmlzbWEuc3VibWlzc2lvbi5maW5kVW5pcXVlKHtcclxuICAgICAgICB3aGVyZTogeyBpZDogc3VibWlzc2lvbklkIH0sXHJcbiAgICAgICAgc2VsZWN0OiB7IGNhbXBhaWduSWQ6IHRydWUgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgaWYgKHN1Ym1pc3Npb24pIHtcclxuICAgICAgICAvLyBSZWNhbGN1bGF0ZSBjYW1wYWlnbiB0b3RhbHMgKGV4Y2x1ZGluZyB0aGlzIHJlamVjdGVkIHN1Ym1pc3Npb24pXHJcbiAgICAgICAgYXdhaXQgdXBkYXRlQ2FtcGFpZ25Ub3RhbFBvaW50cyhzdWJtaXNzaW9uLmNhbXBhaWduSWQsIHByaXNtYSk7XHJcbiAgICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBIb29rIHRvIGNhbGwgd2hlbiBhIGNhbXBhaWduIGlzIGNyZWF0ZWRcclxuICogSW5pdGlhbGl6ZXMgdGhlIGNhbXBhaWduJ3MgY2FsY3VsYXRlZCBmaWVsZHNcclxuICovXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBvbkNhbXBhaWduQ3JlYXRlZChcclxuICAgIGNhbXBhaWduSWQ6IHN0cmluZyxcclxuICAgIHByaXNtYTogUHJpc21hQ2xpZW50XHJcbikge1xyXG4gICAgYXdhaXQgQ2FsY3VsYXRpb25TZXJ2aWNlLmluaXRpYWxpemVDYW1wYWlnbihjYW1wYWlnbklkLCBwcmlzbWEpO1xyXG59XHJcbiJdLCJuYW1lcyI6WyJDYWxjdWxhdGlvblNlcnZpY2UiLCJvblN1Ym1pc3Npb25TdGF0c1VwZGF0ZSIsInN1Ym1pc3Npb25JZCIsInByaXNtYSIsInVwZGF0ZVN1Ym1pc3Npb25DYWxjdWxhdGlvbnMiLCJzdWJtaXNzaW9uIiwiZmluZFVuaXF1ZSIsIndoZXJlIiwiaWQiLCJzZWxlY3QiLCJjYW1wYWlnbklkIiwidXBkYXRlQ2FtcGFpZ25Ub3RhbFBvaW50cyIsInN0YXRzIiwicmVjYWxjdWxhdGVDYW1wYWlnblN1Ym1pc3Npb25zIiwib25TdWJtaXNzaW9uQXBwcm92ZWQiLCJvblN1Ym1pc3Npb25SZWplY3RlZCIsIm9uQ2FtcGFpZ25DcmVhdGVkIiwiaW5pdGlhbGl6ZUNhbXBhaWduIl0sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(rsc)/./server/services/submissionHooks.ts\n");

/***/ })

};
;