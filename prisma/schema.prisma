// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  CREATOR
  ARTIST
  ADMIN
}

enum Tier {
  C
  B
  A
  S
}

enum CampaignStatus {
  ACTIVE
  COMPLETED
}

enum PayoutStatus {
  PENDING
  COMPLETED
}

enum SubmissionStatus {
  PENDING
  APPROVED
  REJECTED
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  EARNING
  SPEND
  REFUND
  ADJUSTMENT
}

enum TransactionStatus {
  PENDING
  COMPLETED
  REJECTED
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String?
  bio           String?   @db.Text
  avatar        String?
  
  role          UserRole  @default(CREATOR)
  balance       Decimal   @default(0) @db.Decimal(10, 2)
  
  followerCount Int       @default(0)
  followingCount Int      @default(0) // ADDED
  totalLikes    Int       @default(0) // ADDED
  videoCount    Int       @default(0) // ADDED
  lastStatsFetchedAt DateTime?        // ADDED
  
  // Social links
  tiktokHandle  String?
  instagramHandle String?
  youtubeHandle String?
  
  // TikTok OAuth (Official API - Legacy)
  tiktok_open_id         String?   @unique
  tiktok_access_token    String?
  tiktok_refresh_token   String?
  tiktok_token_expires_at DateTime?
  tiktok_scopes          String?   // Comma-separated list
  
  // InsightIQ OAuth (Primary TikTok Integration)
  insightiqAccessToken   String?   // Encrypted access token
  insightiqRefreshToken  String?   // Encrypted refresh token
  insightiqTokenExpiry   DateTime? // Token expiration
  tiktokUserId           String?   @unique // TikTok platform_user_id
  tiktokUsername         String?   // TikTok @username
  tiktokDisplayName      String?   // TikTok display name
  tiktokAvatarUrl        String?   // TikTok profile picture
  tiktokConnectedAt      DateTime? // When user connected TikTok
  
  // Subscription
  plan          UserPlan  @default(FREE)
  subscriptionEndsAt DateTime?
  cycleStartDate DateTime @default(now()) // For free plan limits
  
  // InsightIQ session status
  insightiqSessionExpired Boolean @default(false) // Set true when SESSION.EXPIRED webhook received

  // Metadata
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  // Relations
  songs           Song[]
  campaigns       Campaign[]
  submissions     Submission[]
  transactions    Transaction[]
  notifications   Notification[]
  contactMessages ContactMessage[]

  @@index([email])
  @@index([role])
}

model Song {
  id          String   @id @default(cuid())
  title       String
  artist      User     @relation(fields: [artistId], references: [id], onDelete: Cascade)
  artistId    String
  
  // TikTok link (optional for backward compatibility with existing data)
  tiktokUrl   String?
  duration    Int?     // in seconds (optional - may not be known from music page URLs)
  
  // Metadata
  coverImage  String?
  description String?  @db.Text
  
  // InsightIQ Music Metadata
  tiktokMusicId    String?   @unique // TikTok's internal music ID (from audio_track_info.id)
  videoCount       Int?      // Number of videos using this music
  authorName       String?   // Original artist name from TikTok (audio_track_info.artist)
  musicCoverUrl    String?   // Official music cover art (audio_track_info.cover_url)
  musicUrl         String?   // TikTok music page URL (audio_track_info.url)
  
  // Cache metadata
  statsLastFetched DateTime? // When stats were last updated
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  campaigns   Campaign[]
  
  @@index([artistId])
  @@index([tiktokMusicId])
  @@index([title])
  @@index([authorName])
}

model Campaign {
  id              String         @id @default(cuid())
  song            Song           @relation(fields: [songId], references: [id], onDelete: Cascade)
  songId          String
  artist          User           @relation(fields: [artistId], references: [id], onDelete: Cascade)
  artistId        String
  
  // Budget & Pricing
  totalBudget     Decimal        @db.Decimal(10, 2)
  remainingBudget Decimal        @db.Decimal(10, 2)
  
  // Tier (nullable - null for new campaigns, populated for legacy)
  tier            Tier?
  durationDays    Int            @default(7)   // User-selected: 5-30 days

  // Payout System
  commissionPercent     Int      @default(20)  // Budget-bracket-based: 20k→20%, 40k→15%, 70k→12%, 100k→10%
  payoutStatus          PayoutStatus @default(PENDING)

  // Requirements
  minVideoDuration Int?          // in seconds
  
  // Campaign details
  title           String
  description     String?        @db.Text
  status          CampaignStatus @default(ACTIVE)
  
  // Timestamps
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  startDate       DateTime?      // Set on admin approval (timer starts from approval)
  endDate         DateTime?      // Auto-calculated: startDate + durationDays
  completedAt     DateTime?

  // v2: Scheduling & approval
  desiredStartDate DateTime?     // Artist's chosen start date (min createdAt + 3 days)
  lockedAt         DateTime?     // When submissions were locked (1h before endDate)
  nextMetricsFetchAt DateTime?   // Next scheduled metrics fetch (24h cadence from startDate)
  metricsProcessingAt DateTime?  // Set when cron starts processing; cleared on completion (concurrency guard)
  insuranceTriggered Boolean     @default(false) // Whether insurance refund was applied

  // Computed fields for backend calculations
  totalCampaignPoints Float        @default(0)  // Total views across all submissions (views-only system)
  netBudgetTP         Float        @default(0)  // DEPRECATED - no longer used
  netMultiplier       Float        @default(0)  // (100 - commissionPercent) / 100

  // Relations
  submissions     Submission[]
  poolStats       CampaignPoolStats?
  metricFetchLogs MetricFetchLog[]

  @@index([songId])
  @@index([artistId])
  @@index([status])
  @@index([createdAt])
  @@index([startDate])
  @@index([endDate])
  @@index([payoutStatus])
  @@index([durationDays])
  @@index([status, endDate]) // For filtering active/completed campaigns
  @@index([status, endDate, lockedAt]) // For pre-distribute and distribute crons
  @@index([artistId, createdAt(sort: Desc)]) // For getMyCampaigns optimization
  @@index([title]) // For search optimization
  @@index([status, nextMetricsFetchAt]) // For per-campaign metrics cron
}

model Submission {
  id              String           @id @default(cuid())
  campaign        Campaign         @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  campaignId      String
  creator         User             @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  creatorId       String
  
  // TikTok video info
  tiktokUrl          String
  tiktokVideoId      String?
  insightiqContentId String?    // InsightIQ internal content UUID (for webhook matching)
  
  // Verification data
  verified        Boolean          @default(false)
  verifiedAt      DateTime?
  rejectionReason String?          @db.Text
  
  // Performance metrics
  lastViewCount   Int              @default(0)
  lastLikeCount   Int              @default(0)
  lastCommentCount Int             @default(0)
  lastShareCount  Int              @default(0)  // Shares metric for payout
  totalEarnings   Decimal          @default(0) @db.Decimal(10, 2)
  
  // Payout calculation fields
  impactScore     Float?           // Calculated at payout time
  payoutAmount    Decimal?         @db.Decimal(10, 2) // Final calculated payout
  estimatedEarnings Decimal          @default(0) @db.Decimal(10, 2)
  contributionPercent Float          @default(0)
  
  // DEPRECATED: point fields no longer used (views-only system)
  viewPoints      Float            @default(0)
  likePoints      Float            @default(0)
  sharePoints     Float            @default(0)
  totalPoints     Float            @default(0)
  sharePercent    Float            @default(0)  // percentage of campaign pool (max 40%)
  
  // Status
  status          SubmissionStatus @default(PENDING)
  
  // Metadata
  creatorFollowers Int?
  videoDuration   Int?             // in seconds
  
  // Timestamps
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  lastCheckedAt   DateTime?        // Last time views were updated
  
  // Multi-submission: creators can submit up to 10 videos per campaign
  // @@unique([campaignId, creatorId]) — removed to allow multi-submission
  @@index([campaignId])
  @@index([creatorId])
  @@index([status])
  @@index([createdAt])
  @@index([campaignId, status]) // For efficient filtering
  @@index([campaignId, creatorId]) // For joined campaigns optimization
  @@index([creatorId, createdAt(sort: Desc)]) // For user submission history
  @@index([creatorId, status]) // For active video counts and status filtering
  @@index([insightiqContentId]) // For webhook matching
}

model CampaignPoolStats {
  id                    String   @id @default(cuid())
  campaign              Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  campaignId            String   @unique

  // Aggregated statistics (views-only system)
  totalCampaignPoints   Float    @default(0)  // Total views across all approved submissions
  totalSubmissions      Int      @default(0)  // Count of approved submissions
  averagePoints         Float    @default(0)  // Average views per submission

  // Batch tracking
  lastBatchAt           DateTime?             // When last batch recalculation ran
  lastBatchTotalPoints  Float    @default(0)  // Total views snapshot from last batch

  // Timestamps
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([campaignId])
}

model MetricFetchLog {
  id              String   @id @default(cuid())
  campaign        Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  campaignId      String
  submissionId    String?            // null if campaign-level log
  source          String             // "WEBHOOK" | "ON_DEMAND" | "SUBMISSION" | "FINAL"
  status          String             // "SUCCESS" | "FAILED" | "SKIPPED" | "INSURANCE_TRIGGERED"
  errorMessage    String?  @db.Text
  metricsSnapshot Json?              // { views, likes, shares, points } at time of fetch
  webhookEventId  String?            // InsightIQ webhook id for idempotency

  createdAt       DateTime @default(now())

  @@index([campaignId])
  @@index([webhookEventId])
  @@index([createdAt])
}

model Transaction {
  id              String            @id @default(cuid())
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          String
  
  // Transaction details
  type            TransactionType
  amount          Decimal           @db.Decimal(10, 2)
  status          TransactionStatus @default(PENDING)
  
  // Additional info
  description     String?           @db.Text
  reference       String?           // Bank reference or submission ID
  notes           String?           @db.Text // Admin notes
  
  // For deposits/withdrawals
  bankDetails     String?           @db.Text
  
  // Approval
  approvedBy      String?           // Admin user ID
  approvedAt      DateTime?
  
  // Timestamps
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model Notification {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  
  // Notification content
  title       String
  message     String   @db.Text
  link        String?  // Optional link to related resource
  
  // Status
  read        Boolean  @default(false)
  
  // Timestamps
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

model ContactMessage {
  id        String   @id @default(cuid())
  userId    String?
  name      String?
  email     String
  subject   String
  message   String   @db.Text
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([read])
  @@index([createdAt])
}

model SystemSettings {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String   @db.Text
  description String?  @db.Text
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([key])
}

model MusicCache {
  id            String   @id @default(cuid())
  tiktokMusicId String
  cacheType     String   // "trending_videos" or "music_info"
  data          Json     // Cached API response
  expiresAt     DateTime
  createdAt     DateTime @default(now())
  
  @@index([tiktokMusicId, cacheType])
  @@index([expiresAt])
}

model ApiCallLog {
  id          String   @id @default(cuid())
  provider    String   @default("INTERNAL") // "RAPIDAPI" | "APIFY" | "INTERNAL"
  endpoint    String   // e.g., "/api/post/detail", "/api/music/info"
  method      String   // GET, POST, etc.
  statusCode  Int?     // HTTP status code
  success     Boolean  @default(true)
  duration    Int?     // Response time in milliseconds
  errorMessage String? @db.Text
  context     String?  // e.g., "cron:per-campaign-metrics", "router:submitVideo", "router:fetchSongPreview"
  campaignId  String?  // Related campaign if applicable
  userId      String?  // User who triggered the call (if applicable)
  isFallback  Boolean  @default(false) // True if this was a fallback call (Apify after RapidAPI failed)
  createdAt   DateTime @default(now())

  @@index([provider])
  @@index([endpoint])
  @@index([createdAt])
  @@index([success])
  @@index([provider, createdAt])
  @@index([context])
}

enum UserPlan {
  FREE
  PRO
  ARTIST
}

model AdminAuditLog {
  id          String   @id @default(cuid())
  adminId     String
  adminEmail  String
  action      String   // CAMPAIGN_APPROVE, CAMPAIGN_REJECT, TRANSACTION_APPROVE, etc.
  targetType  String   // Campaign, Transaction, User, Settings
  targetId    String?
  details     Json?    // Contextual info (e.g., { reason: "...", amount: 100 })
  ipAddress   String?
  createdAt   DateTime @default(now())

  @@index([adminId])
  @@index([action])
  @@index([createdAt])
  @@index([targetType])
}